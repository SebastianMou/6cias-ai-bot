<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle de Encuesta</title>

    <!-- PDF Generation Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Word Document Generation Library - Using jsdelivr -->
    <script src="https://cdn.jsdelivr.net/npm/docx@9.5.3/dist/index.iife.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

        <!-- Fallback check for docx library -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                if (typeof docx === 'undefined' && typeof window.docx === 'undefined') {
                    console.warn('‚ö†Ô∏è docx library failed to load - tracking prevention may be blocking it');
                } else {
                    console.log('‚úÖ docx library loaded successfully');
                }
            }, 1000);
        });
    </script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f7fa;
        }

        .header {
            background: linear-gradient(135deg, #008386 0%, #427174 100%);
            color: white;
            padding: 20px 40px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .back-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .header-info h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .header-info p {
            font-size: 14px;
            opacity: 0.9;
        }

        .header-actions {
            display: flex;
            gap: 10px;
        }

        .header-btn {
            padding: 10px 20px;
            border: 2px solid white;
            background: transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.3s;
        }

        .header-btn:hover {
            background: white;
            color: #008386;
        }

        .header-btn.delete {
            background: #dc3545;
            border-color: #dc3545;
        }

        .header-btn.delete:hover {
            background: #c82333;
            border-color: #c82333;
            color: white;
        }

        .container {
            margin: 30px auto;
            padding: 0 20px;
            max-width:2400px; /* Limits the width */
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: white;
            padding:15px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border-left: 4px solid #008386;
        }

        .summary-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-card .value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .summary-card .sub-value {
            font-size: 14px;
            color: #999;
            margin-top: 5px;
        }

        .status-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .status-complete {
            background: #d4edda;
            color: #155724;
        }

        .status-in-progress {
            background: #fff3cd;
            color: #856404;
        }

        .status-incomplete {
            background: #f8d7da;
            color: #721c24;
        }

        .progress-bar-container {
            margin-top: 15px;
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #008386 0%, #00a8ab 100%);
            transition: width 0.5s ease;
        }

        /* Tabs */
        .tabs-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            overflow: hidden;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
            overflow-y: hidden;
            scrollbar-width: thin;
            scrollbar-color: #008386 #f8f9fa;
        }

        /* Webkit scrollbar for tabs */
        .tabs::-webkit-scrollbar {
            height: 6px;
        }

        .tabs::-webkit-scrollbar-track {
            background: #f8f9fa;
        }

        .tabs::-webkit-scrollbar-thumb {
            background: #008386;
            border-radius: 3px;
        }

        .tabs::-webkit-scrollbar-thumb:hover {
            background: #006b6d;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 15px;
            font-weight: 600;
            color: #666;
            white-space: nowrap;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab:hover {
            background: rgba(0, 131, 134, 0.1);
        }

        .tab.active {
            color: #008386;
            border-bottom-color: #008386;
            background: white;
        }

        .tab-content {
            display: none;
            padding: 30px;
            max-height: 600px;
            overflow-y: auto;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .data-section {
            margin-bottom: 30px;
        }

        .data-section h3 {
            font-size: 18px;
            color: #008386;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #008386;
        }

        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
        }

        .data-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 3px solid #008386;
        }

        .data-label {
            font-size: 12px;
            color: #666;
            font-weight: 600;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .data-value {
            font-size: 15px;
            color: #333;
            word-wrap: break-word;
        }

        .data-value.empty {
            color: #999;
            font-style: italic;
        }

        .chat-messages {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            animation: fadeIn 0.3s ease-in;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 12px;
            word-wrap: break-word;
            line-height: 1.5;
        }

        .user-message {
            justify-content: flex-end;
        }

        .user-message .message-content {
            background: linear-gradient(135deg, #008386 0%, #427174 100%);
            color: white;
        }

        .bot-message {
            justify-content: flex-start;
        }

        .bot-message .message-content {
            background: white;
            color: #333;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .timestamp {
            font-size: 11px;
            color: #999;
            margin-top: 5px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #008386;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Modal styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 30px auto;
            padding: 0;
            border-radius: 12px;
            width: 90%;
            max-width: 900px;
            max-height: 85vh;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #008386 0%, #427174 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            font-size: 22px;
        }

        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.3s;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .modal-body {
            padding: 30px;
            max-height: calc(85vh - 140px);
            overflow-y: auto;
        }

        .form-section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-section:last-of-type {
            border-bottom: none;
        }

        .form-section h3 {
            color: #008386;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 600;
            font-size: 14px;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #008386;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #e0e0e0;
        }

        .form-actions button {
            padding: 12px 30px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .form-actions button[type="button"] {
            background: #6c757d;
            color: white;
        }

        .form-actions button[type="button"]:hover {
            background: #5a6268;
        }

        .form-actions button[type="submit"] {
            background: #008386;
            color: white;
        }

        .form-actions button[type="submit"]:hover {
            background: #006b6d;
        }

        .sidebar {
            background: white;
            border-radius: 12px;
            padding: 25px;
            height: calc(100vh - 120px);  /* Full screen height minus header and margin */
            max-height: calc(100vh - 120px);
            overflow-y: auto;  /* Make it scrollable */
            overflow-x: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            position: sticky;
            top: 20px;
        }

        .sidebar-section {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #f0f0f0;
        }

        .sidebar-section:last-child {
            border-bottom: none;
        }

        .sidebar-label {
            font-size: 11px;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 5px;
        }

        .sidebar-value {
            font-size: 14px;
            color: #333;
            font-weight: 500;
            word-break: break-all;
        }

        .sidebar-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            margin-bottom: 10px;
            transition: all 0.3s;
        }

        .sidebar-btn.edit {
            background: #008386;
            color: white;
        }

        .sidebar-btn.edit:hover {
            background: #006b6d;
        }

        .sidebar-btn.delete {
            background: #dc3545;
            color: white;
        }

        .sidebar-btn.delete:hover {
            background: #c82333;
        }

        .audit-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            z-index: 10000;
            display: none;
            min-width: 300px;
            animation: slideIn 0.3s ease-out;
        }

        .audit-notification.show {
            display: block;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .audit-notification h3 {
            margin: 0 0 10px 0;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .audit-notification p {
            margin: 5px 0;
            font-size: 14px;
            opacity: 0.9;
        }

        .audit-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* File attachments in conversation */
        .message-file-attachment {
            margin-top: 8px;
            padding: 8px;
            background: rgba(0, 0, 0, 0.05);
            border-radius: 8px;
            display: inline-block;
            max-width: 100%;
        }

        .message-file-attachment img {
            max-width: 250px;
            max-height: 250px;
            border-radius: 5px;
            display: block;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .message-file-attachment img:hover {
            transform: scale(1.05);
        }

        .message-file-attachment .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            background: white;
            border-radius: 5px;
            font-size: 13px;
        }

        .message-file-attachment .file-info:hover {
            background: #f0f0f0;
        }

        .file-icon-large {
            font-size: 24px;
        }

        /* Files tab gallery */
        .files-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            padding: 20px;
        }

        #download-all-btn:hover {
            background: #059669;
        }

        #download-all-btn:active {
            transform: scale(0.98);
        }

        #download-all-btn:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }

        .file-card {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .file-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .file-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .file-card .file-details {
            padding: 12px;
        }

        .file-card .file-name {
            font-size: 13px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            word-break: break-word;
        }

        .file-card .file-meta {
            font-size: 11px;
            color: #999;
        }

        .file-card.document {
            display: flex;
            align-items: center;
            padding: 15px;
        }

        .file-card.document .doc-icon {
            font-size: 48px;
            margin-right: 15px;
        }

        /* Image modal for fullscreen view */
        .image-modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            align-items: center;
            justify-content: center;
        }

        .image-modal.show {
            display: flex;
        }

        .image-modal img {
            max-width: 90%;
            max-height: 90%;
            border-radius: 8px;
        }

        .image-modal .close-modal {
            position: absolute;
            top: 20px;
            right: 40px;
            color: white;
            font-size: 40px;
            cursor: pointer;
            font-weight: bold;
        }

        .image-modal .close-modal:hover {
            color: #ccc;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #e0e0e0;
            overflow-x: auto;
        }

        .connection-log {
            padding: 15px;
            margin-bottom: 10px;
            border-left: 4px solid;
            border-radius: 4px;
            background: #f8f9fa;
        }

        .connection-log.good {
            border-left-color: #28a745;
            background: #d4edda;
        }

        .connection-log.moderate {
            border-left-color: #ffc107;
            background: #fff3cd;
        }

        .connection-log.poor {
            border-left-color: #ff9800;
            background: #ffe5cc;
        }

        .connection-log.offline {
            border-left-color: #dc3545;
            background: #f8d7da;
        }

        .connection-log-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .connection-log-quality {
            font-weight: 600;
            font-size: 16px;
        }

        .connection-log-time {
            font-size: 12px;
            color: #666;
        }

        .connection-log-details {
            font-size: 13px;
            color: #666;
        }

        .connection-stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
            text-align: center;
        }

        .connection-stat-value {
            font-size: 28px;
            font-weight: bold;
            margin: 10px 0;
        }

        .connection-stat-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }

        :root {
            --bg-primary: #f5f7fa;
            --bg-secondary: #ffffff;
            --bg-header: linear-gradient(135deg, #008386 0%, #427174 100%);
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-muted: #999999;
            --border-color: #e0e0e0;
            --shadow: rgba(0, 0, 0, 0.08);
            --accent: #008386;
            --accent-hover: #006668;
            --input-bg: #ffffff;
            --card-bg: #ffffff;
        }

        /* Dark Mode Variables */
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-header: linear-gradient(135deg, #005557 0%, #2a3a3c 100%);
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-muted: #888888;
            --border-color: #3a3a3a;
            --shadow: rgba(0, 0, 0, 0.3);
            --accent: #00a8ab;
            --accent-hover: #008386;
            --input-bg: #3a3a3a;
            --card-bg: #2d2d2d;
        }

        /* Auto Dark Mode (respects system preference) */
        @media (prefers-color-scheme: dark) {
            :root:not([data-theme="light"]) {
                --bg-primary: #1a1a1a;
                --bg-secondary: #2d2d2d;
                --bg-header: linear-gradient(135deg, #005557 0%, #2a3a3c 100%);
                --text-primary: #e0e0e0;
                --text-secondary: #b0b0b0;
                --text-muted: #888888;
                --border-color: #3a3a3a;
                --shadow: rgba(0, 0, 0, 0.3);
                --accent: #00a8ab;
                --accent-hover: #008386;
                --input-bg: #3a3a3a;
                --card-bg: #2d2d2d;
            }
        }

        /* Apply Variables to Body */
        body {
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .header {
            background: var(--bg-header);
        }

        /* Dark Mode Overrides */
        [data-theme="dark"] .sidebar,
        [data-theme="dark"] .summary-card,
        [data-theme="dark"] .tabs-container,
        [data-theme="dark"] .tab-content,
        [data-theme="dark"] .data-section,
        [data-theme="dark"] .connection-stat-card,
        [data-theme="dark"] .file-card,
        [data-theme="dark"] .modal-content {
            background: var(--card-bg);
            color: var(--text-primary);
            box-shadow: 0 2px 8px var(--shadow);
        }

        [data-theme="dark"] .sidebar-label,
        [data-theme="dark"] .summary-card h3,
        [data-theme="dark"] .data-label,
        [data-theme="dark"] .connection-stat-label {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .sidebar-value,
        [data-theme="dark"] .data-value,
        [data-theme="dark"] .summary-card .value {
            color: var(--text-primary);
        }

        [data-theme="dark"] .tabs {
            background: var(--bg-primary);
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .tab {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .tab:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        [data-theme="dark"] .tab.active {
            background: var(--card-bg);
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        [data-theme="dark"] input,
        [data-theme="dark"] textarea,
        [data-theme="dark"] select {
            background: var(--input-bg);
            border-color: var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] input:focus,
        [data-theme="dark"] textarea:focus,
        [data-theme="dark"] select:focus {
            border-color: var(--accent);
        }

        [data-theme="dark"] .data-item,
        [data-theme="dark"] .sidebar-section {
            border-bottom-color: var(--border-color);
        }

        [data-theme="dark"] .sidebar-btn {
            background: var(--accent);
        }

        [data-theme="dark"] .sidebar-btn:hover {
            background: var(--accent-hover);
        }

        [data-theme="dark"] .sidebar-btn.edit {
            background: #1e40af;
        }

        [data-theme="dark"] .sidebar-btn.edit:hover {
            background: #2563eb;
        }

        [data-theme="dark"] .sidebar-btn.delete {
            background: #b91c1c;
        }

        [data-theme="dark"] .sidebar-btn.delete:hover {
            background: #dc2626;
        }

        [data-theme="dark"] .status-complete {
            background: #1a3a2a;
            color: #4ade80;
        }

        [data-theme="dark"] .status-in-progress {
            background: #3a3520;
            color: #fbbf24;
        }

        [data-theme="dark"] .status-incomplete {
            background: #3a1a1a;
            color: #f87171;
        }

        [data-theme="dark"] .progress-bar {
            background: var(--border-color);
        }

        [data-theme="dark"] .message-bubble {
            background: var(--card-bg);
            color: var(--text-primary);
        }

        [data-theme="dark"] .message-bubble.user {
            background: var(--accent);
            color: white;
        }

        [data-theme="dark"] .message-time {
            color: var(--text-muted);
        }

        [data-theme="dark"] .connection-log.good {
            background: #1a3a2a;
            border-left-color: #28a745;
        }

        [data-theme="dark"] .connection-log.moderate {
            background: #3a3520;
            border-left-color: #ffc107;
        }

        [data-theme="dark"] .connection-log.poor {
            background: #3a2a20;
            border-left-color: #ff9800;
        }

        [data-theme="dark"] .connection-log.offline {
            background: #3a1a1a;
            border-left-color: #dc3545;
        }

        [data-theme="dark"] .back-btn {
            background: rgba(255, 255, 255, 0.15);
        }

        [data-theme="dark"] .back-btn:hover {
            background: rgba(255, 255, 255, 0.25);
        }

        /* Dark Mode Toggle Button */
        .dark-mode-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s;
        }

        .dark-mode-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

         /* Data Grid and Items - Force dark mode */
        [data-theme="dark"] .data-grid {
            background: transparent;
            border-top-color: var(--border-color);
        }

        [data-theme="dark"] .data-item {
            background: transparent;
            border-bottom: 1px solid var(--border-color);
        }

        [data-theme="dark"] .data-section {
            background: var(--card-bg);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        [data-theme="dark"] .data-section h3 {
            color: var(--text-primary);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        /* Summary Cards Grid */
        [data-theme="dark"] .summary-cards {
            background: transparent;
        }

        [data-theme="dark"] .summary-card {
            background: var(--card-bg) !important;
            color: var(--text-primary) !important;
            box-shadow: 0 2px 8px var(--shadow);
        }

        [data-theme="dark"] .summary-card h3 {
            color: var(--text-secondary) !important;
        }

        [data-theme="dark"] .summary-card .value {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] .summary-card .sub-value {
            color: var(--text-muted) !important;
        }

        /* Tabs Container */
        [data-theme="dark"] .tabs-container {
            background: var(--card-bg);
            box-shadow: 0 2px 8px var(--shadow);
        }

        /* All Tab Content Panels */
        [data-theme="dark"] .tab-content {
            background: var(--card-bg);
            padding: 20px;
        }

        [data-theme="dark"] #tab-info-basica,
        [data-theme="dark"] #tab-domicilio,
        [data-theme="dark"] #tab-patrimonial,
        [data-theme="dark"] #tab-empleo,
        [data-theme="dark"] #tab-finanzas,
        [data-theme="dark"] #tab-salud,
        [data-theme="dark"] #tab-contactos,
        [data-theme="dark"] #tab-vivienda,
        [data-theme="dark"] #tab-licencias,
        [data-theme="dark"] #tab-conversacion,
        [data-theme="dark"] #tab-connection,
        [data-theme="dark"] #tab-archivos {
            background: var(--bg-secondary);
        }

        /* Container */
        [data-theme="dark"] .container {
            background: transparent;
        }

        /* Main Content Area */
        [data-theme="dark"] .main-content {
            background: transparent;
        }

        /* Chat Messages Container */
        [data-theme="dark"] .chat-messages {
            background: var(--card-bg);
            border-radius: 8px;
            padding: 15px;
        }

        [data-theme="dark"] #chat-messages {
            background: var(--card-bg);
        }

        [data-theme="dark"] #download-all-btn {
            background: #059669;
        }

        [data-theme="dark"] #download-all-btn:hover {
            background: #047857;
        }

        /* Files Gallery */
        [data-theme="dark"] .files-gallery {
            background: transparent;
        }

        [data-theme="dark"] .file-card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        [data-theme="dark"] .file-card:hover {
            border-color: var(--accent);
            background: var(--bg-secondary);
        }

        /* Connection Summary and Timeline */
        [data-theme="dark"] #connection-summary {
            background: transparent;
        }

        [data-theme="dark"] #connection-timeline {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 8px;
        }

        [data-theme="dark"] #connection-logs {
            background: transparent;
        }

        /* Connection Stats */
        [data-theme="dark"] .connection-stat-card {
            background: var(--card-bg) !important;
            box-shadow: 0 2px 4px var(--shadow);
        }

        [data-theme="dark"] .connection-stat-value {
            color: var(--text-primary);
        }

        [data-theme="dark"] .connection-stat-label {
            color: var(--text-secondary);
        }

        /* Loading and No Data States */
        [data-theme="dark"] .loading {
            color: var(--text-muted);
            background: transparent;
        }

        [data-theme="dark"] .no-data {
            color: var(--text-muted);
        }

        /* Form Modal */
        [data-theme="dark"] .modal {
            background: rgba(0, 0, 0, 0.85);
        }

        [data-theme="dark"] .modal-content {
            background: var(--card-bg);
        }

        [data-theme="dark"] .modal-header {
            background: var(--accent);
            border-bottom: 1px solid var(--border-color);
        }

        [data-theme="dark"] .modal-body {
            background: var(--card-bg);
        }

        [data-theme="dark"] .modal-footer {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
        }

        /* Form Sections */
        [data-theme="dark"] .form-section {
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 20px;
            margin-bottom: 20px;
        }

        [data-theme="dark"] .form-section h3 {
            color: var(--text-primary);
        }

        [data-theme="dark"] .form-group {
            background: transparent;
        }

        [data-theme="dark"] .form-group label {
            color: var(--text-secondary);
        }

        /* Form Actions */
        [data-theme="dark"] .form-actions {
            background: var(--card-bg);
            border-top: 1px solid var(--border-color);
        }

        [data-theme="dark"] .form-actions button {
            background: var(--accent);
            color: white;
        }

        [data-theme="dark"] .form-actions button:hover {
            background: var(--accent-hover);
        }

        /* Close Button */
        [data-theme="dark"] .close-btn {
            color: white;
        }

        /* Audit Notification */
        [data-theme="dark"] .audit-notification {
            background: var(--card-bg);
            border: 2px solid var(--accent);
            color: var(--text-primary);
        }

        [data-theme="dark"] .audit-notification h3 {
            color: var(--text-primary);
        }

        /* Image Modal */
        [data-theme="dark"] .image-modal {
            background: rgba(0, 0, 0, 0.95);
        }

        [data-theme="dark"] .close-modal {
            color: white;
        }

        /* Scrollbars for Dark Mode (Webkit browsers) */
        [data-theme="dark"] ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--bg-primary);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }

        /* Connection Details in Summary Card */
        [data-theme="dark"] #connection-status {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] #connection-details {
            color: var(--text-secondary) !important;
        }

        /* Progress Fill */
        [data-theme="dark"] .progress-fill {
            background: linear-gradient(90deg, var(--accent) 0%, var(--accent-hover) 100%);
        }

        /* Status Display */
        [data-theme="dark"] #status-display {
            color: var(--text-primary);
        }

        /* Text Elements */
        [data-theme="dark"] p,
        [data-theme="dark"] span,
        [data-theme="dark"] div {
            color: inherit;
        }

        /* Links */
        [data-theme="dark"] a {
            color: var(--accent);
        }

        [data-theme="dark"] a:hover {
            color: var(--accent-hover);
        }

        /* Location Map Modal Dark Mode */
        [data-theme="dark"] #location-map-modal {
            background: rgba(0, 0, 0, 0.9);
        }

        [data-theme="dark"] #location-map-modal > div {
            background: var(--card-bg) !important;
            color: var(--text-primary);
        }

        [data-theme="dark"] #location-map-modal h3 {
            color: var(--text-primary);
        }

        [data-theme="dark"] #location-map-modal h4 {
            color: var(--text-primary);
        }

        [data-theme="dark"] #location-map-modal button {
            background: #dc3545;
        }

        [data-theme="dark"] #location-map-modal button:hover {
            background: #c82333;
        }

        [data-theme="dark"] #map-ip-info,
        [data-theme="dark"] #map-declared-info {
            color: var(--text-primary);
        }

        [data-theme="dark"] #location-map-modal > div > div:nth-child(2) > div:nth-child(1) {
            background: #1e3a5f !important;
            border-left-color: #3b82f6;
        }

        [data-theme="dark"] #location-map-modal > div > div:nth-child(2) > div:nth-child(2) {
            background: #3a2f1f !important;
            border-left-color: #f59e0b;
        }

        [data-theme="dark"] #verification-status {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        [data-theme="dark"] #location-map-container {
            border-color: var(--border-color);
        }
        /* Location Map Modal - Force Text Colors in Dark Mode */
        [data-theme="dark"] #map-ip-info,
        [data-theme="dark"] #map-declared-info,
        [data-theme="dark"] #map-ip-info *,
        [data-theme="dark"] #map-declared-info * {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] #location-map-modal div[style*="font-size: 14px"] {
            color: var(--text-primary) !important;
        }

        [data-theme="dark"] #verification-status {
            background: var(--bg-secondary) !important;
            color: var(--text-primary) !important;
        }

        /* Info boxes text */
        [data-theme="dark"] #location-map-modal div[style*="background: #f0f9ff"] {
            background: #1e3a5f !important;
        }

        [data-theme="dark"] #location-map-modal div[style*="background: #fef3c7"] {
            background: #3a2f1f !important;
        }

        [data-theme="dark"] #location-map-modal div[style*="color: #1e40af"] {
            color: #60a5fa !important;
        }

        [data-theme="dark"] #location-map-modal div[style*="color: #92400e"] {
            color: #fbbf24 !important;
        }

        [data-theme="dark"] #location-map-modal div[style*="background: #e0f2fe"] {
            background: #1e3a5f !important;
            border-color: #3b82f6 !important;
        }
        
        [data-theme="dark"] #location-map-modal div[style*="color: #0369a1"] {
            color: #60a5fa !important;
        }
        
        /* Declared Address Box - Yellow */
        [data-theme="dark"] #location-map-modal div[style*="background: #fef3c7"] {
            background: #3a2f1f !important;
            border-color: #f59e0b !important;
        }
        
        [data-theme="dark"] #location-map-modal div[style*="color: #92400e"] {
            color: #fbbf24 !important;
        }
        
        /* Browser Box - Light Blue */
        [data-theme="dark"] #location-map-modal div[style*="background: #dbeafe"] {
            background: #1e40af33 !important;
            border-color: #3b82f6 !important;
        }
        
        [data-theme="dark"] #location-map-modal div[style*="color: #1e40af"] {
            color: #93c5fd !important;
        }
        
        /* Screen Box - Purple */
        [data-theme="dark"] #location-map-modal div[style*="background: #e9d5ff"] {
            background: #4c1d9533 !important;
            border-color: #a855f7 !important;
        }
        
        [data-theme="dark"] #location-map-modal div[style*="color: #6b21a8"] {
            color: #d8b4fe !important;
        }
        
        /* Hardware Box - Green */
        [data-theme="dark"] #location-map-modal div[style*="background: #d1fae5"] {
            background: #06573333 !important;
            border-color: #10b981 !important;
        }
        
        [data-theme="dark"] #location-map-modal div[style*="color: #065f46"] {
            color: #6ee7b7 !important;
        }
        
        /* Network Box - Orange */
        [data-theme="dark"] #location-map-modal div[style*="background: #fed7aa"] {
            background: #7c290633 !important;
            border-color: #f97316 !important;
        }
        
        [data-theme="dark"] #location-map-modal div[style*="color: #9a3412"] {
            color: #fdba74 !important;
        }
        
        /* Privacy Box - Red */
        [data-theme="dark"] #location-map-modal div[style*="background: #fecaca"] {
            background: #7f1d1d33 !important;
            border-color: #ef4444 !important;
        }
        
        [data-theme="dark"] #location-map-modal div[style*="color: #991b1b"] {
            color: #fca5a5 !important;
        }
        
        /* Battery Box - Yellow */
        [data-theme="dark"] #location-map-modal div[style*="background: #fef08a"] {
            background: #78350f33 !important;
            border-color: #eab308 !important;
        }
        
        [data-theme="dark"] #location-map-modal div[style*="color: #713f12"] {
            color: #fde047 !important;
        }
        
        /* All text inside info boxes should be readable */
        [data-theme="dark"] #location-map-modal div[style*="margin-bottom: 5px"],
        [data-theme="dark"] #location-map-modal div[style*="font-size: 11px"],
        [data-theme="dark"] #location-map-modal div[style*="font-size: 12px"],
        [data-theme="dark"] #location-map-modal div[style*="font-size: 13px"] {
            color: #e5e7eb !important;
        }
        
        /* Strong tags in modal */
        [data-theme="dark"] #location-map-modal strong {
            color: #f3f4f6 !important;
        }
        
        /* Map info sections */
        [data-theme="dark"] #map-browser-info,
        [data-theme="dark"] #map-screen-info,
        [data-theme="dark"] #map-hardware-info,
        [data-theme="dark"] #map-network-info,
        [data-theme="dark"] #map-privacy-info,
        [data-theme="dark"] #map-battery-info {
            color: #e5e7eb !important;
        }
        
        [data-theme="dark"] #map-browser-info *,
        [data-theme="dark"] #map-screen-info *,
        [data-theme="dark"] #map-hardware-info *,
        [data-theme="dark"] #map-network-info *,
        [data-theme="dark"] #map-privacy-info *,
        [data-theme="dark"] #map-battery-info * {
            color: inherit !important;
        }
        
        /* Override any inline color styles in dark mode */
        [data-theme="dark"] #location-map-modal div[style*="color: #666"] {
            color: #9ca3af !important;
        }
        
        /* Scrollbar for sidebar in dark mode */
        [data-theme="dark"] #location-map-modal > div > div:first-child::-webkit-scrollbar-track {
            background: #374151;
        }
        
        [data-theme="dark"] #location-map-modal > div > div:first-child::-webkit-scrollbar-thumb {
            background: #6b7280;
        }
        
        [data-theme="dark"] #location-map-modal > div > div:first-child::-webkit-scrollbar-thumb:hover {
            background: #9ca3af;
        }
    </style>
</head>

<body>
    <!-- Audit Notification -->
    <div id="audit-notification" class="audit-notification">
        <h3>
            <span class="audit-spinner"></span>
            Auditando Conversaci√≥n
        </h3>
        <p>Analizando respuestas con IA...</p>
        <p id="audit-status">Procesando datos...</p>
    </div>
    <div class="header">
        <div class="header-left">
            <button class="back-btn" onclick="window.location.href='/survey-dashboard'">
                ‚Üê Volver al Dashboard
            </button>
            <div class="header-info">
                <h1>Detalle de Encuesta Econ√≥mica</h1>
            </div>
            <div class="header-actions">
                <button class="header-btn" onclick="exportToPDF()" style="background: #ef4444; border-color: #ef4444;">
                    PDF
                </button>
                <button class="header-btn" onclick="exportToWord()" style="background: #2563eb; border-color: #2563eb;">
                    Word
                </button>
            </div>
        </div>
        
        <button class="dark-mode-toggle" onclick="toggleDarkMode()" title="Cambiar tema">
            <span id="theme-icon">üåô</span>
        </button>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-label">Nombre</div>
                <div class="sidebar-value" id="sidebar-name">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Email</div>
                <div class="sidebar-value" id="sidebar-email">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Tel√©fono</div>
                <div class="sidebar-value" id="sidebar-phone">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Session ID</div>
                <div class="sidebar-value" id="sidebar-session" style="font-size: 10px;">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Fecha de Inicio</div>
                <div class="sidebar-value" id="sidebar-created">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">√öltima Actualizaci√≥n</div>
                <div class="sidebar-value" id="sidebar-updated">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">IP Address</div>
                <div class="sidebar-value" id="sidebar-ip">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Ubicaci√≥n IP</div>
                <div class="sidebar-value" id="sidebar-geo" style="font-size: 12px;">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Direcci√≥n Declarada</div>
                <div class="sidebar-value" id="sidebar-declared-address" style="font-size: 12px;">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Navegador</div>
                <div class="sidebar-value" id="sidebar-browser">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Sistema Operativo</div>
                <div class="sidebar-value" id="sidebar-os">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Pantalla</div>
                <div class="sidebar-value" id="sidebar-screen">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Conexi√≥n</div>
                <div class="sidebar-value" id="sidebar-connection">-</div>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-label">Hardware</div>
                <div class="sidebar-value" id="sidebar-hardware">-</div>
            </div>

            <div class="sidebar-section">
                <button class="sidebar-btn" id="show-map-btn" onclick="showLocationMap()" style="background: #3b82f6; display: none;">
                    üó∫Ô∏è Ver Mapa de Ubicaci√≥n
                </button>
            </div>
            <div class="sidebar-section" style="border-bottom: none;">
                <button class="sidebar-btn edit" onclick="if(currentSurvey) openEditModal(); else alert('Cargando datos...');">‚úèÔ∏è Editar Datos</button>
                <button class="sidebar-btn" onclick="auditSurvey()" style="background: #2563eb;">üîç Auditar Conversaci√≥n</button>
                <button class="sidebar-btn delete" onclick="deleteSurvey()">üóëÔ∏è Eliminar Encuesta</button>
            </div>
        </div>

        <style>
            .main-content {
                max-width: 80%;
                width: 100%;
            }
        </style>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Summary Cards -->
            <div class="summary-cards">
                
                <div class="summary-card">
                    <h3>Progreso</h3>
                    <div class="value" id="progress-value">0%</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="summary-card">
                    <h3>Secci√≥n Actual</h3>
                    <div class="value" id="current-section-display" style="font-size: 18px;">-</div>
                </div>
                <div class="summary-card">
                    <h3>Fecha</h3>
                    <div class="value" id="created-date" style="font-size: 16px;">-</div>
                    <div class="sub-value" id="updated-date">-</div>
                </div>
                <div class="summary-card">
                    <h3>üì∂ Conexi√≥n</h3>
                    <div id="connection-status" class="value" style="font-size: 18px;">-</div>
                    <div id="connection-details" class="sub-value"></div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab active" onclick="switchTab('info-basica')">üìã Info B√°sica</button>
                    <button class="tab" onclick="switchTab('domicilio')">üè† Domicilio</button>
                    <button class="tab" onclick="switchTab('patrimonial')">üí∞ Patrimonial</button>
                    <button class="tab" onclick="switchTab('empleo')">üíº Empleo</button>
                    <button class="tab" onclick="switchTab('finanzas')">üìä Finanzas</button>
                    <button class="tab" onclick="switchTab('salud')">üè• Salud</button>
                    <button class="tab" onclick="switchTab('contactos')">üë• Contactos</button>
                    <button class="tab" onclick="switchTab('vivienda')">üèòÔ∏è Vivienda</button>
                    <button class="tab" onclick="switchTab('licencias')">üöó Licencias</button>
                    <button class="tab" onclick="switchTab('conversacion')">üí¨ Conversaci√≥n</button>
                    <button class="tab" onclick="switchTab('connection')">üì∂ Historial de Conexi√≥n</button>
                    <button class="tab" onclick="switchTab('archivos')">üìé Archivos</button>
                </div>

                <!-- Tab: Info B√°sica -->
                <div id="tab-info-basica" class="tab-content active">
                    <div class="data-section">
                        <h3>A) Informaci√≥n B√°sica</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">Nombre Completo</div>
                                <div class="data-value" id="data-name">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Fecha de Nacimiento</div>
                                <div class="data-value" id="data-dob">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Tel√©fono WhatsApp</div>
                                <div class="data-value" id="data-phone">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Correo Electr√≥nico</div>
                                <div class="data-value" id="data-email">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Session ID</div>
                                <div class="data-value" id="data-session"
                                    style="font-size: 12px; word-break: break-all;">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Domicilio -->
                <div id="tab-domicilio" class="tab-content">
                    <div class="data-section">
                        <h3>B) Domicilio y Ubicaci√≥n</h3>
                        <div class="data-grid">
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Domicilio Completo</div>
                                <div class="data-value" id="data-address">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">¬øComparti√≥ ubicaci√≥n?</div>
                                <div class="data-value" id="data-share-location">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-section">
                        <h3>C) Informaci√≥n de Vivienda</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">Tipo de Vivienda</div>
                                <div class="data-value" id="data-housing-type">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">¬øCon qui√©n vive?</div>
                                <div class="data-value" id="data-lives-with">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">N√∫mero de Dependientes</div>
                                <div class="data-value" id="data-dependents">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Patrimonial -->
                <div id="tab-patrimonial" class="tab-content">
                    <div class="data-section">
                        <h3>D) Bienes Patrimoniales</h3>
                        <div class="data-grid">
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Bienes Inmuebles</div>
                                <div class="data-value" id="data-real-estate">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Veh√≠culos</div>
                                <div class="data-value" id="data-vehicles">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Negocios</div>
                                <div class="data-value" id="data-businesses">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Ahorros Formales</div>
                                <div class="data-value" id="data-savings">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-section">
                        <h3>E) Situaci√≥n de Deuda</h3>
                        <div class="data-grid">
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Adeudos</div>
                                <div class="data-value" id="data-debts">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Bur√≥ de Cr√©dito</div>
                                <div class="data-value" id="data-credit-bureau">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Empleo -->
                <div id="tab-empleo" class="tab-content">
                    <div class="data-section">
                        <h3>F) Escolaridad</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">Nivel de Estudios</div>
                                <div class="data-value" id="data-education">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">¬øTiene comprobante?</div>
                                <div class="data-value" id="data-education-proof">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-section">
                        <h3>G) Empleo y Trayectoria</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">Puesto que Busca</div>
                                <div class="data-value" id="data-position">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Organizaci√≥n/Empresa</div>
                                <div class="data-value" id="data-organization">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">√Årea/Divisi√≥n</div>
                                <div class="data-value" id="data-area">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Motivo de Aplicaci√≥n</div>
                                <div class="data-value" id="data-reason">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">¬øC√≥mo se enter√≥?</div>
                                <div class="data-value" id="data-how-found">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Empleo Actual</div>
                                <div class="data-value" id="data-current-job">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Empleos Anteriores</div>
                                <div class="data-value" id="data-previous-jobs">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Finanzas -->
                <div id="tab-finanzas" class="tab-content">
                    <div class="data-section">
                        <h3>H) Ingresos</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">Sueldo y Bono</div>
                                <div class="data-value" id="data-salary">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Apoyo Familiar/Pareja</div>
                                <div class="data-value" id="data-family-support">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Ingresos Informales</div>
                                <div class="data-value" id="data-informal-income">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-section">
                        <h3>I) Egresos</h3>
                        <div class="data-grid">
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Gastos que Tiene</div>
                                <div class="data-value" id="data-expenses-list">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Montos de Gastos</div>
                                <div class="data-value" id="data-expenses-amounts">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Salud -->
                <div id="tab-salud" class="tab-content">
                    <div class="data-section">
                        <h3>J) Salud y H√°bitos</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">¬øCondici√≥n m√©dica que afecte trabajo?</div>
                                <div class="data-value" id="data-medical">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">¬øMedicamentos permanentes?</div>
                                <div class="data-value" id="data-medication">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Contactos -->
                <div id="tab-contactos" class="tab-content">
                    <div class="data-section">
                        <h3>K) Contactos Familiares</h3>
                        <div class="data-grid">
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Referencias Familia Primaria</div>
                                <div class="data-value" id="data-primary-family" style="white-space: pre-wrap;">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Referencias Familia Secundaria</div>
                                <div class="data-value" id="data-secondary-family" style="white-space: pre-wrap;">-
                                </div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Referencias Laborales</div>
                                <div class="data-value" id="data-work-refs" style="white-space: pre-wrap;">-</div>
                            </div>
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Referencia Personal</div>
                                <div class="data-value" id="data-personal-ref">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Vivienda -->
                <div id="tab-vivienda" class="tab-content">
                    <div class="data-section">
                        <h3>L) Acceso y Caracter√≠sticas</h3>
                        <div class="data-grid">
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Referencias para Ubicar</div>
                                <div class="data-value" id="data-home-refs">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Delincuencia en la Zona</div>
                                <div class="data-value" id="data-crime">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Servicios en la Zona</div>
                                <div class="data-value" id="data-services">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Seguridad en la Zona</div>
                                <div class="data-value" id="data-security">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Vigilancia en la Zona</div>
                                <div class="data-value" id="data-surveillance">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-section">
                        <h3>M) Estado del Inmueble</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">Rec√°maras</div>
                                <div class="data-value" id="data-bedrooms">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Comedor</div>
                                <div class="data-value" id="data-dining">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Sala</div>
                                <div class="data-value" id="data-living">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Ba√±os</div>
                                <div class="data-value" id="data-bathrooms">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Pisos</div>
                                <div class="data-value" id="data-floors">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Jard√≠n/√Åreas Verdes</div>
                                <div class="data-value" id="data-garden">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Cocina</div>
                                <div class="data-value" id="data-kitchen">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Clima (A/C)</div>
                                <div class="data-value" id="data-ac">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Cochera</div>
                                <div class="data-value" id="data-garage">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">√Årea de Lavado</div>
                                <div class="data-value" id="data-laundry-area">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Alberca</div>
                                <div class="data-value" id="data-pool">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">√Åreas Deportivas</div>
                                <div class="data-value" id="data-sports">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Estudio/Oficina</div>
                                <div class="data-value" id="data-office">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Licencias -->
                <div id="tab-licencias" class="tab-content">
                    <div class="data-section">
                        <h3>N) Licencias (Solo Operadores)</h3>
                        <div class="data-grid">
                            <div class="data-item">
                                <div class="data-label">¬øTiene Licencia Federal?</div>
                                <div class="data-value" id="data-federal-license">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">N√∫mero de Licencia</div>
                                <div class="data-value" id="data-license-number">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Folio M√©dico</div>
                                <div class="data-value" id="data-medical-folio">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Vigencia</div>
                                <div class="data-value" id="data-license-validity">-</div>
                            </div>
                            <div class="data-item">
                                <div class="data-label">Tipo/Categor√≠a</div>
                                <div class="data-value" id="data-license-type">-</div>
                            </div>
                        </div>
                    </div>

                    <div class="data-section">
                        <h3>O) Evidencias</h3>
                        <div class="data-grid">
                            <div class="data-item" style="grid-column: 1 / -1;">
                                <div class="data-label">Evidencias Enviadas</div>
                                <div class="data-value" id="data-evidence" style="white-space: pre-wrap;">-</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Archivos -->
                <div id="tab-archivos" class="tab-content">
                    <div class="data-section">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                            <h3 style="margin: 0;">üìé Archivos Adjuntos</h3>
                            <button id="download-all-btn" onclick="downloadAllFiles()" style="display: none; background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 14px; transition: background 0.3s;">
                                ‚¨áÔ∏è Descargar Todos
                            </button>
                        </div>
                        <div class="files-gallery" id="files-gallery">
                            <div class="loading">Cargando archivos...</div>
                        </div>
                    </div>
                </div>

                <!-- Tab: Conversaci√≥n -->
                <div id="tab-conversacion" class="tab-content">
                    <div class="data-section">
                        <h3>üí¨ Historial de Conversaci√≥n</h3>
                        <div class="chat-messages" id="chat-messages">
                            <div class="loading">Cargando conversaci√≥n...</div>
                        </div>
                    </div>
                </div>

                <div id="tab-connection" class="tab-content">
                    <div class="data-section">
                        <h2 style="margin-bottom: 20px; font-size: 20px; color: #333;">üìä Historial de Calidad de Conexi√≥n</h2>
                        
                        <div id="connection-summary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                            <!-- Stats will be populated here -->
                        </div>
                        
                        <div id="connection-timeline" style="background: white; padding: 20px; border-radius: 8px;">
                            <h3 style="margin-bottom: 15px; font-size: 16px; color: #666;">L√≠nea de Tiempo</h3>
                            <div id="connection-logs"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div> <!-- Close main content div -->
    </div> <!-- Close container -->

    <!-- Image Modal for Fullscreen -->
    <div id="image-modal" class="image-modal" onclick="closeImageModal()">
        <span class="close-modal">&times;</span>
        <img id="modal-image" src="" alt="Imagen ampliada">
    </div>

    <!-- Edit Modal -->
    <!-- Edit Modal - COMPLETE VERSION -->
    <div id="edit-modal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Editar Encuesta Socioecon√≥mica - Todos los Campos</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>
            <div class="modal-body">
                <form id="edit-form">

                    <!-- A) BASIC INFO -->
                    <div class="form-section">
                        <h3>A) Informaci√≥n B√°sica</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Nombre Completo:</label>
                                <input type="text" id="edit-name">
                            </div>
                            <div class="form-group">
                                <label>Fecha de Nacimiento:</label>
                                <input type="text" id="edit-dob" placeholder="DD/MM/AAAA">
                            </div>
                            <div class="form-group">
                                <label>Tel√©fono WhatsApp:</label>
                                <input type="text" id="edit-phone">
                            </div>
                            <div class="form-group">
                                <label>Correo Electr√≥nico:</label>
                                <input type="email" id="edit-email">
                            </div>
                        </div>
                    </div>

                    <!-- B) ADDRESS -->
                    <div class="form-section">
                        <h3>B) Domicilio y Ubicaci√≥n</h3>
                        <div class="form-group">
                            <label>Domicilio Completo:</label>
                            <textarea id="edit-address" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>¬øComparti√≥ ubicaci√≥n en tiempo real?</label>
                            <select id="edit-share-location">
                                <option value="">No especificado</option>
                                <option value="true">S√≠</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>

                    <!-- C) HOUSING -->
                    <div class="form-section">
                        <h3>C) Vivienda</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Tipo de Vivienda:</label>
                                <select id="edit-housing-type">
                                    <option value="">Seleccionar...</option>
                                    <option value="propia">Propia</option>
                                    <option value="rentada">Rentada</option>
                                    <option value="prestada">Prestada</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero de Dependientes:</label>
                                <input type="number" id="edit-dependents" min="0">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>¬øCon qui√©n vive?</label>
                            <textarea id="edit-lives-with" rows="2"></textarea>
                        </div>
                    </div>

                    <!-- D) ASSETS 7.1 -->
                    <div class="form-section">
                        <h3>D) Bienes Patrimoniales</h3>
                        <div class="form-group">
                            <label>Bienes Inmuebles (propiedades/terrenos):</label>
                            <textarea id="edit-real-estate" rows="2"
                                placeholder="Descripci√≥n y valor, o 'no tengo'"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Veh√≠culos:</label>
                            <textarea id="edit-vehicles" rows="2"
                                placeholder="Marca, modelo, valor, o 'no tengo'"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Negocios:</label>
                            <textarea id="edit-businesses" rows="2"
                                placeholder="Tipo de negocio, ingresos mensuales, o 'no tengo'"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Ahorros Formales:</label>
                            <textarea id="edit-savings" rows="2" placeholder="Tipo y cantidad, o 'no tengo'"></textarea>
                        </div>
                    </div>

                    <!-- E) DEBT 7.2 -->
                    <div class="form-section">
                        <h3>E) Situaci√≥n de Deuda</h3>
                        <div class="form-group">
                            <label>Adeudos:</label>
                            <textarea id="edit-debts" rows="2"
                                placeholder="Tarjeta, adeudo, pago mensual, o 'no tengo'"></textarea>
                        </div>
                        <div class="form-group">
                            <label>¬øAlguna vez estuvo en Bur√≥ de Cr√©dito?</label>
                            <input type="text" id="edit-credit-bureau" placeholder="S√≠/No/Otros">
                        </div>
                    </div>

                    <!-- F) EDUCATION -->
                    <div class="form-section">
                        <h3>F) Escolaridad</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Nivel de Estudios:</label>
                                <select id="edit-education">
                                    <option value="">Seleccionar...</option>
                                    <option value="Primaria">Primaria</option>
                                    <option value="Secundaria">Secundaria</option>
                                    <option value="Preparatoria">Preparatoria</option>
                                    <option value="T√©cnico">T√©cnico</option>
                                    <option value="Licenciatura">Licenciatura</option>
                                    <option value="Posgrado">Posgrado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>¬øTiene comprobante?</label>
                                <select id="edit-education-proof">
                                    <option value="">No especificado</option>
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- G) EMPLOYMENT -->
                    <div class="form-section">
                        <h3>G) Empleo y Trayectoria</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Puesto que Busca:</label>
                                <input type="text" id="edit-position">
                            </div>
                            <div class="form-group">
                                <label>Organizaci√≥n/Empresa:</label>
                                <input type="text" id="edit-organization">
                            </div>
                            <div class="form-group">
                                <label>√Årea/Divisi√≥n:</label>
                                <input type="text" id="edit-area">
                            </div>
                            <div class="form-group">
                                <label>Motivo de Aplicaci√≥n:</label>
                                <select id="edit-reason">
                                    <option value="">Seleccionar...</option>
                                    <option value="Nuevo ingreso">Nuevo ingreso</option>
                                    <option value="Reingreso">Reingreso</option>
                                    <option value="Promoci√≥n">Promoci√≥n</option>
                                    <option value="Otro">Otro</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>¬øC√≥mo se enter√≥ de la vacante?</label>
                            <textarea id="edit-how-found" rows="2"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Empleo Actual:</label>
                            <textarea id="edit-current-job" rows="2"
                                placeholder="Empresa, puesto, antig√ºedad, horario, sueldo"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Empleos Anteriores (√∫ltimos 2):</label>
                            <textarea id="edit-previous-jobs" rows="3"
                                placeholder="Empresa, puesto, tiempo, motivo de salida"></textarea>
                        </div>
                    </div>

                    <!-- H) INCOME 7.3 -->
                    <div class="form-section">
                        <h3>H) Ingresos</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Sueldo y Bono Mensual:</label>
                                <input type="text" id="edit-salary" placeholder="Rango aproximado">
                            </div>
                            <div class="form-group">
                                <label>Apoyo Familiar/Pareja:</label>
                                <input type="text" id="edit-family-support" placeholder="Cantidad aproximada">
                            </div>
                            <div class="form-group">
                                <label>Ingresos Informales:</label>
                                <input type="text" id="edit-informal-income" placeholder="Cantidad aproximada">
                            </div>
                        </div>
                    </div>

                    <!-- I) EXPENSES 7.4 -->
                    <div class="form-section">
                        <h3>I) Egresos</h3>
                        <div class="form-group">
                            <label>Lista de Gastos que Tiene:</label>
                            <textarea id="edit-expenses-list" rows="2"
                                placeholder="Ej: Despensa, Renta, Luz, etc."></textarea>
                        </div>
                        <div class="form-group">
                            <label>Montos de Gastos (cantidades mensuales):</label>
                            <textarea id="edit-expenses-amounts" rows="3"
                                placeholder="Cantidad aproximada de cada gasto"></textarea>
                        </div>
                    </div>

                    <!-- J) HEALTH -->
                    <div class="form-section">
                        <h3>J) Salud y H√°bitos</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>¬øCondici√≥n m√©dica que afecte trabajo?</label>
                                <select id="edit-medical">
                                    <option value="">No especificado</option>
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>¬øMedicamentos permanentes?</label>
                                <select id="edit-medication">
                                    <option value="">No especificado</option>
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- K) FAMILY CONTACTS 8.0 -->
                    <div class="form-section">
                        <h3>K) Contactos Familiares</h3>
                        <div class="form-group">
                            <label>Referencias Familia Primaria (padres, hermanos, primos, t√≠os):</label>
                            <textarea id="edit-primary-family" rows="3"
                                placeholder="Formato: apellidos, nombres | parentesco | ocupaci√≥n | n√∫mero | ubicaci√≥n"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Referencias Familia Secundaria (pareja, hijos):</label>
                            <textarea id="edit-secondary-family" rows="2"
                                placeholder="Formato: apellidos, nombres | parentesco | ocupaci√≥n | n√∫mero | ubicaci√≥n"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Referencias Laborales (2):</label>
                            <textarea id="edit-work-refs" rows="2"
                                placeholder="Nombre, empresa, puesto, tel√©fono"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Referencia Personal (1):</label>
                            <input type="text" id="edit-personal-ref" placeholder="Nombre, relaci√≥n, tel√©fono">
                        </div>
                    </div>

                    <!-- L) HOME ACCESS 9.0 -->
                    <div class="form-section">
                        <h3>L) Acceso y Caracter√≠sticas Domiciliarias</h3>
                        <div class="form-group">
                            <label>Referencias para Ubicar Domicilio:</label>
                            <textarea id="edit-home-refs" rows="2"
                                placeholder="Ej: A un costado del OXXO, entre calles X y Y"></textarea>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>Delincuencia en la Zona:</label>
                                <select id="edit-crime">
                                    <option value="">Seleccionar...</option>
                                    <option value="Nada">Nada</option>
                                    <option value="Poco">Poco</option>
                                    <option value="Mucho">Mucho</option>
                                    <option value="Demasiado">Demasiado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Servicios en la Zona:</label>
                                <select id="edit-services">
                                    <option value="">Seleccionar...</option>
                                    <option value="Nada">Nada</option>
                                    <option value="Poco">Poco</option>
                                    <option value="Mucho">Mucho</option>
                                    <option value="Demasiado">Demasiado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Seguridad en la Zona:</label>
                                <select id="edit-security">
                                    <option value="">Seleccionar...</option>
                                    <option value="Nada">Nada</option>
                                    <option value="Poco">Poco</option>
                                    <option value="Mucho">Mucho</option>
                                    <option value="Demasiado">Demasiado</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Vigilancia en la Zona:</label>
                                <select id="edit-surveillance">
                                    <option value="">Seleccionar...</option>
                                    <option value="Nada">Nada</option>
                                    <option value="Poco">Poco</option>
                                    <option value="Mucho">Mucho</option>
                                    <option value="Demasiado">Demasiado</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- M) PROPERTY STATUS 9.1 -->
                    <div class="form-section">
                        <h3>M) Estado del Inmueble</h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px;">
                            <div class="form-group">
                                <label>Rec√°maras:</label>
                                <input type="text" id="edit-bedrooms" placeholder="No tengo/S√≠/1/2/3/4">
                            </div>
                            <div class="form-group">
                                <label>Comedor:</label>
                                <input type="text" id="edit-dining" placeholder="No tengo/S√≠">
                            </div>
                            <div class="form-group">
                                <label>Sala:</label>
                                <input type="text" id="edit-living" placeholder="No tengo/S√≠">
                            </div>
                            <div class="form-group">
                                <label>Ba√±os:</label>
                                <input type="text" id="edit-bathrooms" placeholder="No tengo/1/2/3/4">
                            </div>
                            <div class="form-group">
                                <label>Pisos:</label>
                                <input type="text" id="edit-floors" placeholder="1/2/3/4">
                            </div>
                            <div class="form-group">
                                <label>Jard√≠n/√Åreas Verdes:</label>
                                <input type="text" id="edit-garden" placeholder="No tengo/S√≠">
                            </div>
                            <div class="form-group">
                                <label>Cocina:</label>
                                <input type="text" id="edit-kitchen" placeholder="No tengo/S√≠">
                            </div>
                            <div class="form-group">
                                <label>Clima (A/C):</label>
                                <input type="text" id="edit-ac" placeholder="No tengo/S√≠">
                            </div>
                            <div class="form-group">
                                <label>Cochera:</label>
                                <input type="text" id="edit-garage" placeholder="No tengo/S√≠/1/2">
                            </div>
                            <div class="form-group">
                                <label>√Årea de Lavado:</label>
                                <input type="text" id="edit-laundry-area" placeholder="No tengo/S√≠">
                            </div>
                            <div class="form-group">
                                <label>Alberca:</label>
                                <input type="text" id="edit-pool" placeholder="No tengo/S√≠">
                            </div>
                            <div class="form-group">
                                <label>√Åreas Deportivas:</label>
                                <input type="text" id="edit-sports" placeholder="No tengo/S√≠">
                            </div>
                            <div class="form-group">
                                <label>Estudio/Oficina:</label>
                                <input type="text" id="edit-office" placeholder="No tengo/S√≠">
                            </div>
                        </div>
                    </div>

                    <!-- N) LICENSES -->
                    <div class="form-section">
                        <h3>N) Licencias (Solo Operadores)</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <div class="form-group">
                                <label>¬øTiene Licencia Federal?</label>
                                <select id="edit-federal-license">
                                    <option value="">No especificado</option>
                                    <option value="true">S√≠</option>
                                    <option value="false">No</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>N√∫mero de Licencia Federal:</label>
                                <input type="text" id="edit-license-number">
                            </div>
                            <div class="form-group">
                                <label>Folio M√©dico:</label>
                                <input type="text" id="edit-medical-folio">
                            </div>
                            <div class="form-group">
                                <label>Vigencia:</label>
                                <input type="text" id="edit-license-validity" placeholder="mes/a√±o">
                            </div>
                            <div class="form-group">
                                <label>Tipo/Categor√≠a:</label>
                                <input type="text" id="edit-license-type">
                            </div>
                        </div>
                    </div>

                    <!-- O) EVIDENCE -->
                    <div class="form-section">
                        <h3>O) Evidencias</h3>
                        <div class="form-group">
                            <label>Evidencias Enviadas:</label>
                            <textarea id="edit-evidence" rows="3"
                                placeholder="Lista de documentos/fotos enviados"></textarea>
                        </div>
                    </div>

                </form>
            </div>
            <div class="form-actions">
                <button type="button" onclick="closeEditModal()">Cancelar</button>
                <button type="button" onclick="saveEditedSurvey()">üíæ Guardar Todos los Cambios</button>
            </div>
        </div>
    </div>

    <div id="location-map-modal" class="modal">
        <div class="modal-content" style="max-width: 1400px; height: 85vh;">
            <div class="modal-header">
                <h2>üìç Comparaci√≥n de Ubicaciones y Dispositivo</h2>
                <button class="close-btn" onclick="closeLocationMap()">‚úï</button>
            </div>
            
            <div style="display: grid; grid-template-columns: 280px 1fr; gap: 20px; height: calc(100% - 60px); overflow: hidden;">
                <!-- Left sidebar with info - NOW SCROLLABLE -->
                <div style="overflow-y: auto; padding-right: 10px;">
                    <!-- IP Location Info -->
                    <div style="background: #e0f2fe; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-top: 0; color: #0369a1;">üåê Ubicaci√≥n IP</h3>
                        <div id="map-ip-info" style="font-size: 13px;"></div>
                    </div>
                    
                    <!-- Declared Address -->
                    <div style="background: #fef3c7; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-top: 0; color: #92400e;">üìù Direcci√≥n Declarada</h3>
                        <div id="map-declared-info" style="font-size: 13px;"></div>
                    </div>
                    
                    <!-- Verification Status -->
                    <div id="verification-status" style="padding: 10px; border-radius: 5px; font-size: 12px; font-weight: 600; text-align: center; margin-bottom: 15px;"></div>
                    
                    <!-- ADD THIS NEW SECTION: Browser Info -->
                    <div style="background: #dbeafe; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-top: 0; color: #1e40af;">üåê Navegador</h3>
                        <div id="map-browser-info" style="font-size: 12px;"></div>
                    </div>
                    
                    <!-- ADD THIS NEW SECTION: Screen Info -->
                    <div style="background: #e9d5ff; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-top: 0; color: #6b21a8;">üì± Pantalla</h3>
                        <div id="map-screen-info" style="font-size: 12px;"></div>
                    </div>
                    
                    <!-- ADD THIS NEW SECTION: Hardware Info -->
                    <div style="background: #d1fae5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-top: 0; color: #065f46;">‚öôÔ∏è Hardware</h3>
                        <div id="map-hardware-info" style="font-size: 12px;"></div>
                    </div>
                    
                    <!-- ADD THIS NEW SECTION: Network Info -->
                    <div style="background: #fed7aa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-top: 0; color: #9a3412;">üì° Conexi√≥n</h3>
                        <div id="map-network-info" style="font-size: 12px;"></div>
                    </div>
                    
                    <!-- ADD THIS NEW SECTION: Privacy Info -->
                    <div style="background: #fecaca; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <h3 style="margin-top: 0; color: #991b1b;">üîí Privacidad</h3>
                        <div id="map-privacy-info" style="font-size: 12px;"></div>
                    </div>
                    
                    <!-- ADD THIS NEW SECTION: Battery (if available) -->
                    <div id="map-battery-section" style="background: #fef08a; padding: 15px; border-radius: 8px; margin-bottom: 15px; display: none;">
                        <h3 style="margin-top: 0; color: #713f12;">üîã Bater√≠a</h3>
                        <div id="map-battery-info" style="font-size: 12px;"></div>
                    </div>
                </div>
                
                <!-- Map container -->
                <div id="location-map-container" style="border-radius: 8px; overflow: hidden;"></div>
            </div>
        </div>
    </div>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const API_URL = window.location.origin;
        const urlParams = new URLSearchParams(window.location.search);
        const sessionId = urlParams.get('session');

        if (!sessionId) {
            alert('No session ID provided');
            window.location.href = '/survey-dashboard';
        }

        let currentSurvey = null;

        // Tab switching
        function switchTab(tabName) {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            const event = window.event;
            document.getElementById(`tab-${tabName}`).classList.add('active');
            event.target.classList.add('active');
            
            // Load data when switching to specific tabs
            if (tabName === 'conversacion') {
                loadConversation();
            } else if (tabName === 'archivos') {
                loadFiles();
            }
        }

        async function auditSurvey() {
            if (!currentSurvey) {
                alert('Los datos a√∫n no se han cargado. Por favor espera un momento.');
                return;
            }

            if (!confirm('¬øDeseas analizar la conversaci√≥n y actualizar autom√°ticamente los campos? Esto puede sobrescribir datos existentes.')) {
                return;
            }

            try {
                // Show notification
                const notification = document.getElementById('audit-notification');
                const statusText = document.getElementById('audit-status');
                notification.classList.add('show');
                statusText.textContent = 'Procesando conversaci√≥n...';

                const response = await fetch(`${API_URL}/survey/${sessionId}/audit`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    throw new Error('Error en la auditor√≠a');
                }

                const result = await response.json();

                statusText.textContent = `‚úÖ ${result.fields_updated} campos actualizados`;

                // Wait a moment to show success
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Hide notification
                notification.classList.remove('show');

                alert(`‚úÖ Auditor√≠a completada exitosamente.\n${result.fields_updated} campos actualizados.`);
                
                // Reload the survey details
                await loadSurveyDetails();

            } catch (error) {
                console.error('Error during audit:', error);
                
                const notification = document.getElementById('audit-notification');
                const statusText = document.getElementById('audit-status');
                statusText.textContent = '‚ùå Error en la auditor√≠a';
                
                setTimeout(() => {
                    notification.classList.remove('show');
                }, 2000);
                
                alert('‚ùå Error al auditar la conversaci√≥n');
            }
        }

        let locationMap = null;

        function showLocationMap() {
            if (!currentSurvey.ip_latitude || !currentSurvey.ip_longitude) {
                alert('No hay datos de geolocalizaci√≥n disponibles');
                return;
            }

            const modal = document.getElementById('location-map-modal');
            const container = document.getElementById('location-map-container');
            const ipInfo = document.getElementById('map-ip-info');
            const declaredInfo = document.getElementById('map-declared-info');
            const verificationStatus = document.getElementById('verification-status');

            // Show IP info
            ipInfo.innerHTML = `
                <div style="margin-bottom: 5px;"><strong>IP:</strong> ${currentSurvey.user_ip}</div>
                <div style="margin-bottom: 5px;"><strong>Ciudad:</strong> ${currentSurvey.ip_city}</div>
                <div style="margin-bottom: 5px;"><strong>Regi√≥n:</strong> ${currentSurvey.ip_region}</div>
                <div style="margin-bottom: 5px;"><strong>Pa√≠s:</strong> ${currentSurvey.ip_country}</div>
                <div style="margin-bottom: 5px;"><strong>ISP:</strong> ${currentSurvey.ip_isp || 'N/A'}</div>
                <div style="font-size: 11px; color: #666;"><strong>Coordenadas:</strong> ${currentSurvey.ip_latitude}, ${currentSurvey.ip_longitude}</div>
            `;

            // Show declared address
            declaredInfo.innerHTML = `
                <div style="word-wrap: break-word;">${currentSurvey.full_address || 'No proporcionado'}</div>
            `;

            // Populate browser info
            const browserInfo = document.getElementById('map-browser-info');
            if (currentSurvey.browser_name) {
                browserInfo.innerHTML = `
                    <div style="margin-bottom: 5px;"><strong>Navegador:</strong> ${currentSurvey.browser_name} ${currentSurvey.browser_version || ''}</div>
                    <div style="margin-bottom: 5px;"><strong>OS:</strong> ${currentSurvey.browser_os || 'N/A'}</div>
                    <div style="margin-bottom: 5px;"><strong>Plataforma:</strong> ${currentSurvey.browser_platform || 'N/A'}</div>
                    <div style="margin-bottom: 5px;"><strong>Idioma:</strong> ${currentSurvey.browser_language || 'N/A'}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px; word-break: break-all;"><strong>User Agent:</strong> ${currentSurvey.browser_user_agent || 'N/A'}</div>
                `;
            } else {
                browserInfo.innerHTML = '<div style="color: #999;">No disponible</div>';
            }

            // Populate screen info
            const screenInfo = document.getElementById('map-screen-info');
            if (currentSurvey.screen_width) {
                screenInfo.innerHTML = `
                    <div style="margin-bottom: 5px;"><strong>Resoluci√≥n:</strong> ${currentSurvey.screen_width}x${currentSurvey.screen_height}</div>
                    <div style="margin-bottom: 5px;"><strong>Disponible:</strong> ${currentSurvey.screen_avail_width}x${currentSurvey.screen_avail_height}</div>
                    <div style="margin-bottom: 5px;"><strong>Color:</strong> ${currentSurvey.screen_color_depth} bits</div>
                    <div style="margin-bottom: 5px;"><strong>Pixel Ratio:</strong> ${currentSurvey.device_pixel_ratio || 'N/A'}</div>
                    <div style="margin-bottom: 5px;"><strong>Touch:</strong> ${currentSurvey.has_touch_support ? 'S√≠ (' + (currentSurvey.max_touch_points || 0) + ' puntos)' : 'No'}</div>
                `;
            } else {
                screenInfo.innerHTML = '<div style="color: #999;">No disponible</div>';
            }

            // Populate hardware info
            const hardwareInfo = document.getElementById('map-hardware-info');
            if (currentSurvey.cpu_cores || currentSurvey.device_memory) {
                hardwareInfo.innerHTML = `
                    <div style="margin-bottom: 5px;"><strong>CPU:</strong> ${currentSurvey.cpu_cores || 'N/A'} cores</div>
                    <div style="margin-bottom: 5px;"><strong>RAM:</strong> ${currentSurvey.device_memory || 'N/A'} GB</div>
                    <div style="margin-bottom: 5px;"><strong>GPU Vendor:</strong> ${currentSurvey.webgl_vendor || 'N/A'}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px; word-break: break-all;"><strong>GPU:</strong> ${currentSurvey.webgl_renderer || 'N/A'}</div>
                    <div style="font-size: 11px; color: #666; margin-top: 5px;"><strong>Canvas:</strong> ${currentSurvey.canvas_fingerprint || 'N/A'}</div>
                `;
            } else {
                hardwareInfo.innerHTML = '<div style="color: #999;">No disponible</div>';
            }

            // Populate network info
            const networkInfo = document.getElementById('map-network-info');
            if (currentSurvey.connection_effective_type) {
                networkInfo.innerHTML = `
                    <div style="margin-bottom: 5px;"><strong>Tipo:</strong> ${currentSurvey.connection_type || 'N/A'}</div>
                    <div style="margin-bottom: 5px;"><strong>Efectivo:</strong> ${currentSurvey.connection_effective_type.toUpperCase()}</div>
                    <div style="margin-bottom: 5px;"><strong>Velocidad:</strong> ${currentSurvey.connection_downlink || 'N/A'} Mbps</div>
                    <div style="margin-bottom: 5px;"><strong>Latencia:</strong> ${currentSurvey.connection_rtt || 'N/A'} ms</div>
                `;
            } else {
                networkInfo.innerHTML = '<div style="color: #999;">No disponible</div>';
            }

            // Populate privacy info
            const privacyInfo = document.getElementById('map-privacy-info');
            privacyInfo.innerHTML = `
                <div style="margin-bottom: 5px;"><strong>Do Not Track:</strong> ${currentSurvey.do_not_track || 'N/A'}</div>
                <div style="margin-bottom: 5px;"><strong>Cookies:</strong> ${currentSurvey.cookies_enabled ? '‚úÖ S√≠' : '‚ùå No'}</div>
                <div style="margin-bottom: 5px;"><strong>LocalStorage:</strong> ${currentSurvey.local_storage_enabled ? '‚úÖ S√≠' : '‚ùå No'}</div>
                <div style="margin-bottom: 5px;"><strong>SessionStorage:</strong> ${currentSurvey.session_storage_enabled ? '‚úÖ S√≠' : '‚ùå No'}</div>
                <div style="margin-bottom: 5px;"><strong>IndexedDB:</strong> ${currentSurvey.indexed_db_enabled ? '‚úÖ S√≠' : '‚ùå No'}</div>
            `;

            // Populate battery info (if available)
            if (currentSurvey.battery_level !== null && currentSurvey.battery_level !== undefined) {
                document.getElementById('map-battery-section').style.display = 'block';
                document.getElementById('map-battery-info').innerHTML = `
                    <div style="margin-bottom: 5px;"><strong>Nivel:</strong> ${currentSurvey.battery_level}%</div>
                    <div style="margin-bottom: 5px;"><strong>Cargando:</strong> ${currentSurvey.battery_charging ? '‚ö° S√≠' : 'üîå No'}</div>
                `;
            } else {
                document.getElementById('map-battery-section').style.display = 'none';
            }

            modal.style.display = 'flex';

            setTimeout(() => {
                // Clear previous map
                container.innerHTML = '<div id="leaflet-map" style="width: 100%; height: 100%;"></div>';

                // Create map (convert string coordinates to numbers)
                const lat = parseFloat(currentSurvey.ip_latitude);
                const lon = parseFloat(currentSurvey.ip_longitude);
                
                locationMap = L.map('leaflet-map').setView([lat, lon], 13);

                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(locationMap);

                // Add marker for IP location
                L.marker([lat, lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(locationMap)
                    .bindPopup(`<b>üìç Ubicaci√≥n IP</b><br>${currentSurvey.ip_city}, ${currentSurvey.ip_region}<br>${currentSurvey.ip_country}`)
                    .openPopup();

                // Simple verification message
                const declaredLower = (currentSurvey.full_address || '').toLowerCase();
                const cityMatch = declaredLower.includes((currentSurvey.ip_city || '').toLowerCase());
                const regionMatch = declaredLower.includes((currentSurvey.ip_region || '').toLowerCase());

                if (cityMatch || regionMatch) {
                    verificationStatus.style.background = '#d1fae5';
                    verificationStatus.style.color = '#065f46';
                    verificationStatus.innerHTML = '‚úÖ La ubicaci√≥n IP coincide con la direcci√≥n declarada';
                } else {
                    verificationStatus.style.background = '#fee2e2';
                    verificationStatus.style.color = '#991b1b';
                    verificationStatus.innerHTML = '‚ö†Ô∏è La ubicaci√≥n IP no coincide exactamente con la direcci√≥n declarada - Verificar manualmente';
                }
            }, 100);
        }

        function closeLocationMap() {
            document.getElementById('location-map-modal').style.display = 'none';
            if (locationMap) {
                locationMap.remove();
                locationMap = null;
            }
        }

        async function loadSurveyDetails() {
            try {
                const response = await fetch(`${API_URL}/survey/${sessionId}`);
                
                // Check if response is OK
                if (!response.ok) {
                    console.error('Survey not found:', sessionId);
                    throw new Error('Survey not found');
                }
                
                currentSurvey = await response.json();
                
                // Check if survey has minimal data
                if (!currentSurvey || !currentSurvey.session_id) {
                    console.error('Invalid survey data');
                    throw new Error('Invalid survey data');
                }

                // Sidebar
                document.getElementById('sidebar-name').textContent = currentSurvey.candidate_name || 'No proporcionado';
                document.getElementById('sidebar-email').textContent = currentSurvey.email || 'No proporcionado';
                document.getElementById('sidebar-phone').textContent = currentSurvey.phone_whatsapp || 'No proporcionado';
                document.getElementById('sidebar-session').textContent = currentSurvey.session_id;
                
                // Safe date formatting
                document.getElementById('sidebar-created').textContent = currentSurvey.created_at 
                    ? new Date(currentSurvey.created_at).toLocaleDateString('es-MX') 
                    : 'No disponible';
                document.getElementById('sidebar-updated').textContent = currentSurvey.updated_at 
                    ? new Date(currentSurvey.updated_at).toLocaleDateString('es-MX') 
                    : 'No disponible';

                // Populate IP and geolocation data
                document.getElementById('sidebar-ip').textContent = currentSurvey.user_ip || 'No disponible';

                // Populate browser/device info (safe version)
                const browserElem = document.getElementById('sidebar-browser');
                if (browserElem) {
                    if (currentSurvey.browser_name) {
                        browserElem.textContent = `${currentSurvey.browser_name} ${currentSurvey.browser_version || ''}`;
                    } else {
                        browserElem.textContent = 'No disponible';
                    }
                }

                const osElem = document.getElementById('sidebar-os');
                if (osElem) {
                    osElem.textContent = currentSurvey.browser_os || 'No disponible';
                }

                const screenElem = document.getElementById('sidebar-screen');
                if (screenElem) {
                    if (currentSurvey.screen_width && currentSurvey.screen_height) {
                        screenElem.textContent = `${currentSurvey.screen_width}x${currentSurvey.screen_height}`;
                    } else {
                        screenElem.textContent = 'No disponible';
                    }
                }

                const connectionElem = document.getElementById('sidebar-connection');
                if (connectionElem) {
                    if (currentSurvey.connection_effective_type) {
                        connectionElem.textContent = `${currentSurvey.connection_effective_type.toUpperCase()} (${currentSurvey.connection_type || 'unknown'})`;
                    } else {
                        connectionElem.textContent = 'No disponible';
                    }
                }

                const hardwareElem = document.getElementById('sidebar-hardware');
                if (hardwareElem) {
                    if (currentSurvey.cpu_cores || currentSurvey.device_memory) {
                        hardwareElem.textContent = `CPU: ${currentSurvey.cpu_cores || '?'} cores, RAM: ${currentSurvey.device_memory || '?'} GB`;
                    } else {
                        hardwareElem.textContent = 'No disponible';
                    }
                }

                // Populate browser/device info
                if (currentSurvey.browser_name) {
                    document.getElementById('sidebar-browser').textContent = 
                        `${currentSurvey.browser_name} ${currentSurvey.browser_version || ''}`;
                } else {
                    document.getElementById('sidebar-browser').textContent = 'No disponible';
                }

                document.getElementById('sidebar-os').textContent = currentSurvey.browser_os || 'No disponible';

                if (currentSurvey.screen_width && currentSurvey.screen_height) {
                    document.getElementById('sidebar-screen').textContent = 
                        `${currentSurvey.screen_width}x${currentSurvey.screen_height}`;
                } else {
                    document.getElementById('sidebar-screen').textContent = 'No disponible';
                }

                if (currentSurvey.connection_effective_type) {
                    document.getElementById('sidebar-connection').textContent = 
                        `${currentSurvey.connection_effective_type.toUpperCase()} (${currentSurvey.connection_type || 'unknown'})`;
                } else {
                    document.getElementById('sidebar-connection').textContent = 'No disponible';
                }

                if (currentSurvey.cpu_cores || currentSurvey.device_memory) {
                    document.getElementById('sidebar-hardware').textContent = 
                        `CPU: ${currentSurvey.cpu_cores || '?'} cores, RAM: ${currentSurvey.device_memory || '?'} GB`;
                } else {
                    document.getElementById('sidebar-hardware').textContent = 'No disponible';
                }

                if (currentSurvey.ip_city && currentSurvey.ip_region && currentSurvey.ip_country) {
                    document.getElementById('sidebar-geo').innerHTML = `
                        <div><strong>${currentSurvey.ip_city}</strong></div>
                        <div>${currentSurvey.ip_region}, ${currentSurvey.ip_country}</div>
                        <div style="font-size: 11px; color: #666; margin-top: 3px;">üìç ${currentSurvey.ip_latitude}, ${currentSurvey.ip_longitude}</div>
                    `;
                    document.getElementById('show-map-btn').style.display = 'block'; // ‚Üê BUTTON ONLY SHOWS HERE
                } else {
                    document.getElementById('sidebar-geo').textContent = 'No disponible';
                }
                
                document.getElementById('sidebar-declared-address').textContent = currentSurvey.full_address || 'No proporcionado';

                // Summary cards
                const statusHTML = currentSurvey.survey_completed ?
                    '<span class="status-badge status-complete">‚úì Completa</span>' :
                    currentSurvey.current_section ?
                        '<span class="status-badge status-in-progress">‚è≥ En progreso</span>' :
                        '<span class="status-badge status-incomplete">‚äò Incompleta</span>';

                const progress = calculateProgress(currentSurvey);
                document.getElementById('progress-value').textContent = progress + '%';
                document.getElementById('progress-fill').style.width = progress + '%';
                document.getElementById('current-section-display').textContent = currentSurvey.current_section || 'No iniciada';
                document.getElementById('created-date').textContent = new Date(currentSurvey.created_at).toLocaleDateString('es-MX');
                document.getElementById('updated-date').textContent = 'Actualizado: ' + new Date(currentSurvey.updated_at).toLocaleDateString('es-MX');

                // Populate all data fields
                populateDataFields(currentSurvey);

                // Load conversation
                loadConversation();

                loadFiles();

                await loadConnectionHistory();


            } catch (error) {
                console.error('Error loading survey details:', error);
                alert('Error al cargar los detalles de la encuesta');
            }
        }

        function populateDataFields(survey) {
            const setValue = (id, value, isBool = false) => {
                const elem = document.getElementById(id);
                if (!elem) return;

                if (isBool) {
                    if (value === null || value === undefined) {
                        elem.textContent = 'No especificado';
                        elem.classList.add('empty');
                    } else {
                        elem.textContent = value ? 'S√≠' : 'No';
                        elem.classList.remove('empty');
                    }
                } else if (!value || value === '' || value === 'null') {
                    elem.textContent = 'No proporcionado';
                    elem.classList.add('empty');
                } else {
                    elem.textContent = value;
                    elem.classList.remove('empty');
                }
            };

            setValue('data-name', survey.candidate_name);
            setValue('data-dob', survey.date_of_birth);
            setValue('data-phone', survey.phone_whatsapp);
            setValue('data-email', survey.email);
            setValue('data-session', survey.session_id);
            setValue('data-address', survey.full_address);
            setValue('data-share-location', survey.share_location, true);
            setValue('data-housing-type', survey.housing_type);
            setValue('data-lives-with', survey.lives_with);
            setValue('data-dependents', survey.dependents_count);
            setValue('data-real-estate', survey.real_estate);
            setValue('data-vehicles', survey.vehicles);
            setValue('data-businesses', survey.businesses);
            setValue('data-savings', survey.formal_savings);
            setValue('data-debts', survey.debts);
            setValue('data-credit-bureau', survey.credit_bureau);
            setValue('data-education', survey.education_level);
            setValue('data-education-proof', survey.has_education_proof, true);
            setValue('data-position', survey.position_applying);
            setValue('data-organization', survey.organization);
            setValue('data-area', survey.area_division);
            setValue('data-reason', survey.application_reason);
            setValue('data-how-found', survey.how_found_vacancy);
            setValue('data-current-job', survey.current_employment);
            setValue('data-previous-jobs', survey.previous_employment);
            setValue('data-salary', survey.salary_bonus);
            setValue('data-family-support', survey.family_support);
            setValue('data-informal-income', survey.informal_business_income);
            setValue('data-expenses-list', survey.expenses_list);
            setValue('data-expenses-amounts', survey.expenses_amounts);
            setValue('data-medical', survey.has_medical_condition, true);
            setValue('data-medication', survey.takes_permanent_medication, true);
            setValue('data-primary-family', survey.primary_family_contacts);
            setValue('data-secondary-family', survey.secondary_family_contacts);
            setValue('data-work-refs', survey.work_references);
            setValue('data-personal-ref', survey.personal_reference);
            setValue('data-home-refs', survey.home_references);
            setValue('data-crime', survey.crime_in_area);
            setValue('data-services', survey.services_quality);
            setValue('data-security', survey.security_quality);
            setValue('data-surveillance', survey.surveillance_quality);
            setValue('data-bedrooms', survey.bedrooms);
            setValue('data-dining', survey.dining_room);
            setValue('data-living', survey.living_room);
            setValue('data-bathrooms', survey.bathrooms);
            setValue('data-floors', survey.floors);
            setValue('data-garden', survey.garden);
            setValue('data-kitchen', survey.kitchen);
            setValue('data-ac', survey.air_conditioning);
            setValue('data-garage', survey.garage);
            setValue('data-laundry-area', survey.laundry_area);
            setValue('data-pool', survey.pool);
            setValue('data-sports', survey.sports_areas);
            setValue('data-office', survey.study_office);
            setValue('data-federal-license', survey.has_federal_license, true);
            setValue('data-license-number', survey.federal_license_number);
            setValue('data-medical-folio', survey.medical_folio);
            setValue('data-license-validity', survey.license_validity);
            setValue('data-license-type', survey.license_type);
            setValue('data-evidence', survey.evidence_sent);
        }

        async function loadConversation() {
            try {
                const response = await fetch(`${API_URL}/survey/${sessionId}/conversation`);
                const data = await response.json();

                const chatMessages = document.getElementById('chat-messages');

                if (data.conversations.length === 0) {
                    chatMessages.innerHTML = '<div class="empty-state"><p>No hay conversaci√≥n registrada</p></div>';
                    return;
                }

                chatMessages.innerHTML = '';

                // Get all files for this session to match with conversations
                let filesMap = {};
                try {
                    const filesResponse = await fetch(`${API_URL}/survey/${sessionId}/files`);
                    const filesData = await filesResponse.json();
                    
                    if (filesData.files) {
                        // Create a map of original filename to file data
                        filesData.files.forEach(file => {
                            filesMap[file.file_name] = file;
                        });
                    }
                } catch (err) {
                    console.log('Could not load files for conversation');
                }

                data.conversations.forEach(conv => {
                    // Extract file attachments from message
                    const messageText = conv.user_message;
                    const fileMatch = messageText.match(/\[Archivos adjuntos: ([^\]]+)\]/);
                    const cleanMessage = messageText.replace(/\[Archivos adjuntos: [^\]]+\]/, '').trim();
                    
                    let fileAttachmentHTML = '';
                    if (fileMatch) {
                        const fileNames = fileMatch[1].split(', ');
                        
                        fileAttachmentHTML = '<div class="message-file-attachment">';
                        fileNames.forEach(fileName => {
                            const fileData = filesMap[fileName];
                            
                            if (fileData) {
                                const fileUrl = `${API_URL}/survey/file/${sessionId}/${fileData.id}`;
                                
                                if (fileData.file_type && fileData.file_type.startsWith('image/')) {
                                    // Show image thumbnail
                                    fileAttachmentHTML += `
                                        <img src="${fileUrl}" alt="${fileName}" onclick="showImageModal('${fileUrl}')" style="cursor: pointer; max-width: 200px; border-radius: 8px; margin: 5px 0;">
                                    `;
                                } else {
                                    // Show file info
                                    fileAttachmentHTML += `
                                        <div class="file-info" onclick="window.open('${fileUrl}', '_blank')" style="cursor: pointer;">
                                            üìé ${fileName}
                                        </div>
                                    `;
                                }
                            } else {
                                // Fallback if file not found
                                fileAttachmentHTML += `
                                    <div class="file-info">
                                        üìé ${fileName}
                                    </div>
                                `;
                            }
                        });
                        fileAttachmentHTML += '</div>';
                    }
                    
                    chatMessages.innerHTML += `
                        <div class="message user-message">
                            <div class="message-content">
                                ${cleanMessage || 'Archivo adjunto'}
                                ${fileAttachmentHTML}
                                <div class="timestamp">${new Date(conv.created_at).toLocaleTimeString('es-MX')}</div>
                            </div>
                        </div>
                        <div class="message bot-message">
                            <div class="message-content">
                                ${conv.bot_response}
                                <div class="timestamp">${new Date(conv.created_at).toLocaleTimeString('es-MX')}</div>
                            </div>
                        </div>
                    `;
                });

                chatMessages.scrollTop = chatMessages.scrollHeight;

            } catch (error) {
                console.error('Error loading conversation:', error);
            }
        }

        async function loadFiles() {
            try {
                const response = await fetch(`${API_URL}/survey/${sessionId}/files`);
                const data = await response.json();

                const gallery = document.getElementById('files-gallery');

                if (!data.files || data.files.length === 0) {
                    gallery.innerHTML = '<div class="empty-state"><p>No hay archivos adjuntos</p></div>';
                    // Hide download button
                    const downloadBtn = document.getElementById('download-all-btn');
                    if (downloadBtn) {
                        downloadBtn.style.display = 'none';
                    }
                    return;
                }

                gallery.innerHTML = '';

                // Show download all button if there are files
                const downloadBtn = document.getElementById('download-all-btn');
                if (downloadBtn) {
                    downloadBtn.style.display = 'block';
                }

                data.files.forEach(file => {
                    const fileCard = document.createElement('div');
                    const fileUrl = `${API_URL}/survey/file/${sessionId}/${file.id}`;
                    
                    if (file.file_type && file.file_type.startsWith('image/')) {
                        // Image file
                        fileCard.className = 'file-card';
                        fileCard.innerHTML = `
                            <img src="${fileUrl}" alt="${file.file_name}" onclick="event.stopPropagation(); showImageModal('${fileUrl}')">
                            <div class="file-details">
                                <div class="file-name">${file.file_name}</div>
                                <div class="file-meta">${formatFileSize(file.file_size)} ‚Ä¢ ${new Date(file.uploaded_at).toLocaleDateString('es-MX')}</div>
                            </div>
                        `;
                    } else {
                        // Document file
                        fileCard.className = 'file-card document';
                        fileCard.innerHTML = `
                            <div class="doc-icon">üìÑ</div>
                            <div class="file-details">
                                <div class="file-name">${file.file_name}</div>
                                <div class="file-meta">${formatFileSize(file.file_size)} ‚Ä¢ ${new Date(file.uploaded_at).toLocaleDateString('es-MX')}</div>
                            </div>
                        `;
                        fileCard.onclick = () => window.open(fileUrl, '_blank');
                    }

                    gallery.appendChild(fileCard);
                });

            } catch (error) {
                console.error('Error loading files:', error);
                document.getElementById('files-gallery').innerHTML = '<div class="empty-state"><p>Error al cargar archivos</p></div>';
            }
        }

        // Global variable to store files
        let allFiles = [];

        async function downloadAllFiles() {
            const btn = document.getElementById('download-all-btn');
            const originalText = btn.innerHTML;
            
            try {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Descargando...';
                
                const response = await fetch(`${API_URL}/survey/${sessionId}/files`);
                const data = await response.json();
                
                if (!data.files || data.files.length === 0) {
                    alert('No hay archivos para descargar');
                    return;
                }
                
                // Download each file
                for (let i = 0; i < data.files.length; i++) {
                    const file = data.files[i];
                    const fileUrl = `${API_URL}/survey/file/${sessionId}/${file.id}`;
                    
                    btn.innerHTML = `‚è≥ Descargando ${i + 1}/${data.files.length}...`;
                    
                    // Create temporary link and trigger download
                    const link = document.createElement('a');
                    link.href = fileUrl;
                    link.download = file.file_name;
                    link.target = '_blank';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // Small delay between downloads to avoid blocking
                    await new Promise(resolve => setTimeout(resolve, 500));
                }
                
                btn.innerHTML = '‚úÖ Descargado!';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
                
            } catch (error) {
                console.error('Error downloading files:', error);
                alert('Error al descargar archivos');
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i];
        }

        function showImageModal(imageSrc) {
            const modal = document.getElementById('image-modal');
            const modalImage = document.getElementById('modal-image');
            modalImage.src = imageSrc;
            modal.classList.add('show');
        }

        function closeImageModal() {
            document.getElementById('image-modal').classList.remove('show');
        }

        function calculateProgress(survey) {
            let completed = 0;
            const totalSections = 15;

            if (survey.candidate_name && survey.date_of_birth && survey.phone_whatsapp && survey.email) completed++;
            if (survey.full_address) completed++;
            if (survey.housing_type && survey.lives_with) completed++;
            if (survey.real_estate || survey.vehicles || survey.businesses || survey.formal_savings) completed++;
            if (survey.debts || survey.credit_bureau) completed++;
            if (survey.education_level) completed++;
            if (survey.position_applying && survey.organization && survey.current_employment) completed++;
            if (survey.salary_bonus) completed++;
            if (survey.expenses_list && survey.expenses_amounts) completed++;
            if (survey.has_medical_condition !== null) completed++;
            if (survey.primary_family_contacts && survey.work_references && survey.personal_reference) completed++;
            if (survey.home_references && survey.crime_in_area) completed++;
            if (survey.bedrooms) completed++;
            if (survey.has_federal_license !== null) completed++;
            if (survey.evidence_sent) completed++;

            return Math.round((completed / totalSections) * 100);
        }

        async function openEditModal() {

            if (!currentSurvey) {
                alert('Los datos a√∫n no se han cargado. Por favor espera un momento.');
                return;
            }

            try {

                // Populate ALL form fields with current data
                document.getElementById('edit-name').value = currentSurvey.candidate_name || '';
                document.getElementById('edit-dob').value = currentSurvey.date_of_birth || '';
                document.getElementById('edit-phone').value = currentSurvey.phone_whatsapp || '';
                document.getElementById('edit-email').value = currentSurvey.email || '';
                document.getElementById('edit-address').value = currentSurvey.full_address || '';
                document.getElementById('edit-share-location').value = currentSurvey.share_location === null ? '' : currentSurvey.share_location.toString();
                document.getElementById('edit-housing-type').value = currentSurvey.housing_type || '';
                document.getElementById('edit-lives-with').value = currentSurvey.lives_with || '';
                document.getElementById('edit-dependents').value = currentSurvey.dependents_count || '';
                document.getElementById('edit-real-estate').value = currentSurvey.real_estate || '';
                document.getElementById('edit-vehicles').value = currentSurvey.vehicles || '';
                document.getElementById('edit-businesses').value = currentSurvey.businesses || '';
                document.getElementById('edit-savings').value = currentSurvey.formal_savings || '';
                document.getElementById('edit-debts').value = currentSurvey.debts || '';
                document.getElementById('edit-credit-bureau').value = currentSurvey.credit_bureau || '';
                document.getElementById('edit-education').value = currentSurvey.education_level || '';
                document.getElementById('edit-education-proof').value = currentSurvey.has_education_proof === null ? '' : currentSurvey.has_education_proof.toString();
                document.getElementById('edit-position').value = currentSurvey.position_applying || '';
                document.getElementById('edit-organization').value = currentSurvey.organization || '';
                document.getElementById('edit-area').value = currentSurvey.area_division || '';
                document.getElementById('edit-reason').value = currentSurvey.application_reason || '';
                document.getElementById('edit-how-found').value = currentSurvey.how_found_vacancy || '';
                document.getElementById('edit-current-job').value = currentSurvey.current_employment || '';
                document.getElementById('edit-previous-jobs').value = currentSurvey.previous_employment || '';
                document.getElementById('edit-salary').value = currentSurvey.salary_bonus || '';
                document.getElementById('edit-family-support').value = currentSurvey.family_support || '';
                document.getElementById('edit-informal-income').value = currentSurvey.informal_business_income || '';
                document.getElementById('edit-expenses-list').value = currentSurvey.expenses_list || '';
                document.getElementById('edit-expenses-amounts').value = currentSurvey.expenses_amounts || '';
                document.getElementById('edit-medical').value = currentSurvey.has_medical_condition === null ? '' : currentSurvey.has_medical_condition.toString();
                document.getElementById('edit-medication').value = currentSurvey.takes_permanent_medication === null ? '' : currentSurvey.takes_permanent_medication.toString();
                document.getElementById('edit-primary-family').value = currentSurvey.primary_family_contacts || '';
                document.getElementById('edit-secondary-family').value = currentSurvey.secondary_family_contacts || '';
                document.getElementById('edit-work-refs').value = currentSurvey.work_references || '';
                document.getElementById('edit-personal-ref').value = currentSurvey.personal_reference || '';
                document.getElementById('edit-home-refs').value = currentSurvey.home_references || '';
                document.getElementById('edit-crime').value = currentSurvey.crime_in_area || '';
                document.getElementById('edit-services').value = currentSurvey.services_quality || '';
                document.getElementById('edit-security').value = currentSurvey.security_quality || '';
                document.getElementById('edit-surveillance').value = currentSurvey.surveillance_quality || '';
                document.getElementById('edit-bedrooms').value = currentSurvey.bedrooms || '';
                document.getElementById('edit-dining').value = currentSurvey.dining_room || '';
                document.getElementById('edit-living').value = currentSurvey.living_room || '';
                document.getElementById('edit-bathrooms').value = currentSurvey.bathrooms || '';
                document.getElementById('edit-floors').value = currentSurvey.floors || '';
                document.getElementById('edit-garden').value = currentSurvey.garden || '';
                document.getElementById('edit-kitchen').value = currentSurvey.kitchen || '';
                document.getElementById('edit-ac').value = currentSurvey.air_conditioning || '';
                document.getElementById('edit-garage').value = currentSurvey.garage || '';
                document.getElementById('edit-laundry-area').value = currentSurvey.laundry_area || '';
                document.getElementById('edit-pool').value = currentSurvey.pool || '';
                document.getElementById('edit-sports').value = currentSurvey.sports_areas || '';
                document.getElementById('edit-office').value = currentSurvey.study_office || '';
                document.getElementById('edit-federal-license').value = currentSurvey.has_federal_license === null ? '' : currentSurvey.has_federal_license.toString();
                document.getElementById('edit-license-number').value = currentSurvey.federal_license_number || '';
                document.getElementById('edit-medical-folio').value = currentSurvey.medical_folio || '';
                document.getElementById('edit-license-validity').value = currentSurvey.license_validity || '';
                document.getElementById('edit-license-type').value = currentSurvey.license_type || '';
                document.getElementById('edit-evidence').value = currentSurvey.evidence_sent || '';

                // Show modal
                document.getElementById('edit-modal').style.display = 'block';
            } catch (error) {
                console.error('Error opening edit modal:', error);
                alert('Error al abrir el formulario de edici√≥n');
            }
        }

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        async function saveEditedSurvey() {
            try {
                const data = {
                    // A) Basic info
                    candidate_name: document.getElementById('edit-name').value,
                    date_of_birth: document.getElementById('edit-dob').value,
                    phone_whatsapp: document.getElementById('edit-phone').value,
                    email: document.getElementById('edit-email').value,

                    // B) Address
                    full_address: document.getElementById('edit-address').value,
                    share_location: document.getElementById('edit-share-location').value === '' ? null : document.getElementById('edit-share-location').value === 'true',

                    // C) Housing
                    housing_type: document.getElementById('edit-housing-type').value,
                    lives_with: document.getElementById('edit-lives-with').value,
                    dependents_count: parseInt(document.getElementById('edit-dependents').value) || null,

                    // D) Assets
                    real_estate: document.getElementById('edit-real-estate').value,
                    vehicles: document.getElementById('edit-vehicles').value,
                    businesses: document.getElementById('edit-businesses').value,
                    formal_savings: document.getElementById('edit-savings').value,

                    // E) Debt
                    debts: document.getElementById('edit-debts').value,
                    credit_bureau: document.getElementById('edit-credit-bureau').value,

                    // F) Education
                    education_level: document.getElementById('edit-education').value,
                    has_education_proof: document.getElementById('edit-education-proof').value === '' ? null : document.getElementById('edit-education-proof').value === 'true',

                    // G) Employment
                    position_applying: document.getElementById('edit-position').value,
                    organization: document.getElementById('edit-organization').value,
                    area_division: document.getElementById('edit-area').value,
                    application_reason: document.getElementById('edit-reason').value,
                    how_found_vacancy: document.getElementById('edit-how-found').value,
                    current_employment: document.getElementById('edit-current-job').value,
                    previous_employment: document.getElementById('edit-previous-jobs').value,

                    // H) Income
                    salary_bonus: document.getElementById('edit-salary').value,
                    family_support: document.getElementById('edit-family-support').value,
                    informal_business_income: document.getElementById('edit-informal-income').value,

                    // I) Expenses
                    expenses_list: document.getElementById('edit-expenses-list').value,
                    expenses_amounts: document.getElementById('edit-expenses-amounts').value,

                    // J) Health
                    has_medical_condition: document.getElementById('edit-medical').value === '' ? null : document.getElementById('edit-medical').value === 'true',
                    takes_permanent_medication: document.getElementById('edit-medication').value === '' ? null : document.getElementById('edit-medication').value === 'true',

                    // K) Family contacts
                    primary_family_contacts: document.getElementById('edit-primary-family').value,
                    secondary_family_contacts: document.getElementById('edit-secondary-family').value,
                    work_references: document.getElementById('edit-work-refs').value,
                    personal_reference: document.getElementById('edit-personal-ref').value,

                    // L) Home access
                    home_references: document.getElementById('edit-home-refs').value,
                    crime_in_area: document.getElementById('edit-crime').value,
                    services_quality: document.getElementById('edit-services').value,
                    security_quality: document.getElementById('edit-security').value,
                    surveillance_quality: document.getElementById('edit-surveillance').value,

                    // M) Property status
                    bedrooms: document.getElementById('edit-bedrooms').value,
                    dining_room: document.getElementById('edit-dining').value,
                    living_room: document.getElementById('edit-living').value,
                    bathrooms: document.getElementById('edit-bathrooms').value,
                    floors: document.getElementById('edit-floors').value,
                    garden: document.getElementById('edit-garden').value,
                    kitchen: document.getElementById('edit-kitchen').value,
                    air_conditioning: document.getElementById('edit-ac').value,
                    garage: document.getElementById('edit-garage').value,
                    laundry_area: document.getElementById('edit-laundry-area').value,
                    pool: document.getElementById('edit-pool').value,
                    sports_areas: document.getElementById('edit-sports').value,
                    study_office: document.getElementById('edit-office').value,

                    // N) Operators
                    has_federal_license: document.getElementById('edit-federal-license').value === '' ? null : document.getElementById('edit-federal-license').value === 'true',
                    federal_license_number: document.getElementById('edit-license-number').value,
                    medical_folio: document.getElementById('edit-medical-folio').value,
                    license_validity: document.getElementById('edit-license-validity').value,
                    license_type: document.getElementById('edit-license-type').value,

                    // O) Evidence
                    evidence_sent: document.getElementById('edit-evidence').value
                };

                const response = await fetch(`${API_URL}/survey/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('‚úÖ Encuesta actualizada exitosamente');
                    closeEditModal();
                    loadSurveyDetails(); // Reload the page data
                } else {
                    alert('‚ùå Error al actualizar la encuesta');
                }
            } catch (error) {
                console.error('Error saving survey:', error);
                alert('‚ùå Error al guardar los cambios');
            }
        }
        

        function closeEditModal() {
            document.getElementById('edit-modal').style.display = 'none';
        }

        async function saveEditedSurvey() {
            try {
                const data = {
                    candidate_name: document.getElementById('edit-name').value,
                    date_of_birth: document.getElementById('edit-dob').value,
                    phone_whatsapp: document.getElementById('edit-phone').value,
                    email: document.getElementById('edit-email').value,
                    full_address: document.getElementById('edit-address').value,
                    housing_type: document.getElementById('edit-housing-type').value,
                    lives_with: document.getElementById('edit-lives-with').value,
                    real_estate: document.getElementById('edit-real-estate').value,
                    vehicles: document.getElementById('edit-vehicles').value,
                    position_applying: document.getElementById('edit-position').value,
                    organization: document.getElementById('edit-organization').value,
                    current_employment: document.getElementById('edit-current-job').value,
                    salary_bonus: document.getElementById('edit-salary').value,
                    family_support: document.getElementById('edit-family-support').value,
                    informal_business_income: document.getElementById('edit-informal-income').value,
                    expenses_list: document.getElementById('edit-expenses-list').value,
                    expenses_amounts: document.getElementById('edit-expenses-amounts').value,
                    primary_family_contacts: document.getElementById('edit-primary-family').value,
                    work_references: document.getElementById('edit-work-refs').value,
                    bedrooms: document.getElementById('edit-bedrooms').value,
                    bathrooms: document.getElementById('edit-bathrooms').value,
                    garage: document.getElementById('edit-garage').value,
                    garden: document.getElementById('edit-garden').value,
                };

                const response = await fetch(`${API_URL}/survey/${sessionId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    alert('‚úÖ Encuesta actualizada exitosamente');
                    closeEditModal();
                    loadSurveyDetails(); // Reload the page data
                } else {
                    alert('‚ùå Error al actualizar la encuesta');
                }
            } catch (error) {
                console.error('Error saving survey:', error);
                alert('‚ùå Error al guardar los cambios');
            }
        }

        async function deleteSurvey() {
            const name = currentSurvey.candidate_name || 'esta encuesta';

            if (!confirm(`¬øEst√°s seguro de eliminar ${name}? Esta acci√≥n no se puede deshacer.`)) {
                return;
            }

            try {
                const response = await fetch(`${API_URL}/survey/${sessionId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    alert('Encuesta eliminada exitosamente');
                    window.location.href = '/survey-dashboard';
                } else {
                    alert('Error al eliminar la encuesta');
                }
            } catch (error) {
                alert('Error al eliminar la encuesta');
            }
        }

        loadSurveyDetails();

        async function loadConnectionHistory() {
            try {
                const response = await fetch(`${API_URL}/survey/${sessionId}/connection-history`);
                
                if (!response.ok) {
                    console.log('No connection history available');
                    return;
                }
                
                const data = await response.json();
                const logs = data.logs || [];
                
                updateConnectionSummary(logs);
                updateConnectionStats(logs);
                displayConnectionTimeline(logs);
                
            } catch (error) {
                console.error('Error loading connection history:', error);
            }
        }

        function updateConnectionSummary(logs) {
            if (logs.length === 0) {
                document.getElementById('connection-status').textContent = 'Sin datos';
                document.getElementById('connection-details').textContent = 'No se han registrado conexiones';
                return;
            }
            
            const latest = logs[0];
            const offlineCount = logs.filter(l => l.event === 'offline').length;
            const poorCount = logs.filter(l => l.quality === 'baja' || l.quality === 'muy baja').length;
            
            let statusIcon = 'üì∂';
            let statusText = latest.quality || 'desconocida';
            
            if (offlineCount > 0) {
                statusIcon = 'üî¥';
                statusText = 'Con problemas';
            } else if (poorCount > 2) {
                statusIcon = '‚ö†Ô∏è';
                statusText = 'Irregular';
            }
            
            document.getElementById('connection-status').innerHTML = `${statusIcon} ${statusText}`;
            document.getElementById('connection-details').innerHTML = `
                ${logs.length} verificaciones<br>
                ${offlineCount > 0 ? `üî¥ ${offlineCount} desconexi√≥n(es)<br>` : ''}
                ${poorCount > 0 ? `‚ö†Ô∏è ${poorCount} problema(s)` : '‚úÖ Sin problemas'}
            `;
        }

        function updateConnectionStats(logs) {
            if (logs.length === 0) return;
            
            const offlineCount = logs.filter(l => l.event === 'offline').length;
            const poorCount = logs.filter(l => l.quality === 'baja' || l.quality === 'muy baja').length;
            const avgSpeed = logs.filter(l => l.speed).reduce((sum, l) => sum + parseFloat(l.speed), 0) / logs.filter(l => l.speed).length || 0;
            
            const summaryHTML = `
                <div class="connection-stat-card">
                    <div class="connection-stat-label">Total Verificaciones</div>
                    <div class="connection-stat-value" style="color: #008386;">${logs.length}</div>
                </div>
                <div class="connection-stat-card">
                    <div class="connection-stat-label">Desconexiones</div>
                    <div class="connection-stat-value" style="color: ${offlineCount > 0 ? '#dc3545' : '#28a745'};">${offlineCount}</div>
                </div>
                <div class="connection-stat-card">
                    <div class="connection-stat-label">Problemas de Calidad</div>
                    <div class="connection-stat-value" style="color: ${poorCount > 0 ? '#ff9800' : '#28a745'};">${poorCount}</div>
                </div>
                <div class="connection-stat-card">
                    <div class="connection-stat-label">Velocidad Promedio</div>
                    <div class="connection-stat-value" style="color: #008386;">${avgSpeed.toFixed(1)} Mbps</div>
                </div>
            `;
            
            document.getElementById('connection-summary').innerHTML = summaryHTML;
        }

        function displayConnectionTimeline(logs) {
            if (logs.length === 0) {
                document.getElementById('connection-logs').innerHTML = '<p style="text-align: center; color: #999; padding: 40px;">No hay registros de conexi√≥n</p>';
                return;
            }
            
            const timelineHTML = logs.map(log => {
                let className = 'good';
                let icon = 'üì∂';
                
                if (log.event === 'offline') {
                    className = 'offline';
                    icon = 'üìµ';
                } else if (log.quality === 'muy baja' || log.quality === 'baja') {
                    className = 'poor';
                    icon = '‚ö†Ô∏è';
                } else if (log.quality === 'regular') {
                    className = 'moderate';
                    icon = 'üì∂';
                }
                
                const date = new Date(log.timestamp);
                const timeString = date.toLocaleString('es-MX');
                
                return `
                    <div class="connection-log ${className}">
                        <div class="connection-log-header">
                            <span class="connection-log-quality">${icon} ${log.quality || log.event}</span>
                            <span class="connection-log-time">${timeString}</span>
                        </div>
                        <div class="connection-log-details">
                            Velocidad: ${log.speed || 'N/A'} Mbps | 
                            Tipo: ${log.type || 'N/A'} | 
                            Latencia: ${log.latency || 'N/A'}ms
                            ${log.event ? ` | Evento: ${log.event}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('connection-logs').innerHTML = timelineHTML;
        }

        function showDeviceDetails() {
            const modal = document.getElementById('device-modal');
            const content = document.getElementById('device-details-content');
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px;">
                    <!-- Browser Info -->
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #3b82f6;">üåê Navegador</h3>
                        <p><strong>User Agent:</strong><br>${currentSurvey.browser_user_agent || 'N/A'}</p>
                        <p><strong>Nombre:</strong> ${currentSurvey.browser_name || 'N/A'}</p>
                        <p><strong>Versi√≥n:</strong> ${currentSurvey.browser_version || 'N/A'}</p>
                        <p><strong>Plataforma:</strong> ${currentSurvey.browser_platform || 'N/A'}</p>
                        <p><strong>Idioma:</strong> ${currentSurvey.browser_language || 'N/A'}</p>
                        <p><strong>Zona Horaria:</strong> ${currentSurvey.browser_timezone || 'N/A'}</p>
                    </div>
                    
                    <!-- Screen Info -->
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #8b5cf6;">üì± Pantalla</h3>
                        <p><strong>Resoluci√≥n:</strong> ${currentSurvey.screen_width}x${currentSurvey.screen_height}</p>
                        <p><strong>√Årea disponible:</strong> ${currentSurvey.screen_avail_width}x${currentSurvey.screen_avail_height}</p>
                        <p><strong>Profundidad de color:</strong> ${currentSurvey.screen_color_depth} bits</p>
                        <p><strong>Pixel Ratio:</strong> ${currentSurvey.device_pixel_ratio || 'N/A'}</p>
                        <p><strong>Touch:</strong> ${currentSurvey.has_touch_support ? 'S√≠' : 'No'} (${currentSurvey.max_touch_points || 0} puntos)</p>
                    </div>
                    
                    <!-- Hardware -->
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #10b981;">‚öôÔ∏è Hardware</h3>
                        <p><strong>CPU Cores:</strong> ${currentSurvey.cpu_cores || 'N/A'}</p>
                        <p><strong>Memoria:</strong> ${currentSurvey.device_memory || 'N/A'} GB</p>
                        <p><strong>WebGL Vendor:</strong> ${currentSurvey.webgl_vendor || 'N/A'}</p>
                        <p><strong>WebGL Renderer:</strong> ${currentSurvey.webgl_renderer || 'N/A'}</p>
                        <p><strong>Canvas Hash:</strong> ${currentSurvey.canvas_fingerprint || 'N/A'}</p>
                    </div>
                    
                    <!-- Network -->
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #f59e0b;">üì° Conexi√≥n</h3>
                        <p><strong>Tipo:</strong> ${currentSurvey.connection_type || 'N/A'}</p>
                        <p><strong>Tipo efectivo:</strong> ${currentSurvey.connection_effective_type || 'N/A'}</p>
                        <p><strong>Downlink:</strong> ${currentSurvey.connection_downlink || 'N/A'} Mbps</p>
                        <p><strong>RTT:</strong> ${currentSurvey.connection_rtt || 'N/A'} ms</p>
                    </div>
                    
                    <!-- Privacy & Storage -->
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #ef4444;">üîí Privacidad</h3>
                        <p><strong>Do Not Track:</strong> ${currentSurvey.do_not_track || 'N/A'}</p>
                        <p><strong>Cookies:</strong> ${currentSurvey.cookies_enabled ? 'Habilitadas' : 'Deshabilitadas'}</p>
                        <p><strong>LocalStorage:</strong> ${currentSurvey.local_storage_enabled ? 'S√≠' : 'No'}</p>
                        <p><strong>SessionStorage:</strong> ${currentSurvey.session_storage_enabled ? 'S√≠' : 'No'}</p>
                        <p><strong>IndexedDB:</strong> ${currentSurvey.indexed_db_enabled ? 'S√≠' : 'No'}</p>
                    </div>
                    
                    <!-- Battery -->
                    ${currentSurvey.battery_level !== null ? `
                    <div style="background: #f9fafb; padding: 15px; border-radius: 8px;">
                        <h3 style="margin-top: 0; color: #84cc16;">üîã Bater√≠a</h3>
                        <p><strong>Nivel:</strong> ${currentSurvey.battery_level}%</p>
                        <p><strong>Cargando:</strong> ${currentSurvey.battery_charging ? 'S√≠' : 'No'}</p>
                    </div>
                    ` : ''}
                </div>
            `;
            
            modal.style.display = 'flex';
        }

        function closeDeviceModal() {
            document.getElementById('device-modal').style.display = 'none';
        }

        // Dark Mode Functions
        const themeToggle = {
            init() {
                const savedTheme = localStorage.getItem('theme');
                const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme) {
                    this.setTheme(savedTheme);
                } else if (systemPrefersDark) {
                    this.setTheme('dark');
                }
                
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', (e) => {
                    if (!localStorage.getItem('theme')) {
                        this.setTheme(e.matches ? 'dark' : 'light');
                    }
                });
            },
            
            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                this.updateIcon(theme);
            },
            
            toggle() {
                const currentTheme = document.documentElement.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                this.setTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            },
            
            updateIcon(theme) {
                const icon = document.getElementById('theme-icon');
                if (icon) {
                    icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
                }
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            themeToggle.init();
        });

        function toggleDarkMode() {
            themeToggle.toggle();
        }

        // ==========================================
        // ENHANCED PDF EXPORT WITH IMAGES
        // ==========================================
        async function exportToPDF() {
            if (!currentSurvey) {
                alert('Por favor espera a que se carguen los datos');
                return;
            }
            
            // Show loading
            const btn = document.querySelector('button[onclick="exportToPDF()"]');
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Generando PDF...';
            }
            
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                
                let yPos = 20;
                const pageHeight = 280;
                const margin = 20;
                const lineHeight = 7;
                
                // Get all images from survey
                let surveyImages = [];
                try {
                    const response = await fetch(`${API_URL}/survey/${sessionId}/files`);
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        surveyImages = data.files.filter(f => f.file_type && f.file_type.startsWith('image/'));
                    }
                } catch (e) {
                    console.log('No images to include');
                }
                
                // Helper function to add new page if needed
                const checkPageBreak = () => {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                    }
                };
                
                // Helper to add text with wrapping
                const addText = (text, fontSize = 10, isBold = false) => {
                    doc.setFontSize(fontSize);
                    doc.setFont(undefined, isBold ? 'bold' : 'normal');
                    const lines = doc.splitTextToSize(text, 170);
                    lines.forEach(line => {
                        checkPageBreak();
                        doc.text(line, margin, yPos);
                        yPos += lineHeight;
                    });
                };
                
                const addSection = (title) => {
                    yPos += 5;
                    checkPageBreak();
                    doc.setFillColor(0, 131, 134);
                    doc.rect(margin, yPos - 5, 170, 8, 'F');
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text(title, margin + 2, yPos);
                    doc.setTextColor(0, 0, 0);
                    yPos += 10;
                };
                
                const addField = (label, value) => {
                    checkPageBreak();
                    doc.setFont(undefined, 'bold');
                    doc.setFontSize(10);
                    doc.text(label + ':', margin, yPos);
                    doc.setFont(undefined, 'normal');
                    const lines = doc.splitTextToSize(value || 'No proporcionado', 120);
                    doc.text(lines, margin + 50, yPos);
                    yPos += lineHeight * lines.length;
                };
                
                // HEADER
                doc.setFillColor(0, 131, 134);
                doc.rect(0, 0, 210, 40, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.text('ENCUESTA SOCIOECON√ìMICA', margin, 15);
                doc.setFontSize(12);
                doc.text('6Cias - Reporte Completo', margin, 25);
                doc.setFontSize(10);
                doc.text(`Generado: ${new Date().toLocaleString('es-MX')}`, margin, 32);
                doc.setTextColor(0, 0, 0);
                yPos = 50;
                
                // INFORMACI√ìN GENERAL
                addSection('INFORMACI√ìN GENERAL');
                addField('Session ID', currentSurvey.session_id);
                addField('Nombre', currentSurvey.candidate_name);
                addField('Email', currentSurvey.email);
                addField('Tel√©fono', currentSurvey.phone_whatsapp);
                addField('Fecha de Creaci√≥n', currentSurvey.created_at ? new Date(currentSurvey.created_at).toLocaleDateString('es-MX') : 'N/A');
                addField('√öltima Actualizaci√≥n', currentSurvey.updated_at ? new Date(currentSurvey.updated_at).toLocaleDateString('es-MX') : 'N/A');
                addField('Estado', currentSurvey.survey_completed ? 'Completa ‚úì' : 'Incompleta ‚äò');
                
                // UBICACI√ìN E IP
                addSection('UBICACI√ìN E IP');
                addField('IP Address', currentSurvey.user_ip);
                addField('Ciudad', currentSurvey.ip_city);
                addField('Regi√≥n', currentSurvey.ip_region);
                addField('Pa√≠s', currentSurvey.ip_country);
                addField('C√≥digo Postal', currentSurvey.ip_postal_code);
                addField('Coordenadas', currentSurvey.ip_latitude && currentSurvey.ip_longitude ? 
                    `${currentSurvey.ip_latitude}, ${currentSurvey.ip_longitude}` : 'N/A');
                addField('ISP', currentSurvey.ip_isp);
                addField('Organizaci√≥n', currentSurvey.ip_organization);
                addField('Timezone', currentSurvey.ip_timezone);
                addField('Es Proxy/VPN', currentSurvey.ip_is_proxy ? 'S√≠ ‚ö†Ô∏è' : 'No');
                addField('Conexi√≥n M√≥vil', currentSurvey.ip_is_mobile ? 'S√≠' : 'No');
                
                // NAVEGADOR Y DISPOSITIVO
                addSection('NAVEGADOR Y DISPOSITIVO');
                addField('Navegador', `${currentSurvey.browser_name || 'N/A'} ${currentSurvey.browser_version || ''}`);
                addField('Sistema Operativo', currentSurvey.browser_os);
                addField('Plataforma', currentSurvey.browser_platform);
                addField('Idioma', currentSurvey.browser_language);
                addField('Resoluci√≥n', currentSurvey.screen_width ? `${currentSurvey.screen_width}x${currentSurvey.screen_height}` : 'N/A');
                addField('Profundidad Color', currentSurvey.screen_color_depth ? `${currentSurvey.screen_color_depth} bits` : 'N/A');
                addField('CPU Cores', currentSurvey.cpu_cores?.toString());
                addField('RAM', currentSurvey.device_memory ? `${currentSurvey.device_memory} GB` : 'N/A');
                addField('GPU', currentSurvey.webgl_vendor);
                addField('Conexi√≥n', currentSurvey.connection_effective_type?.toUpperCase());
                addField('Velocidad', currentSurvey.connection_downlink ? `${currentSurvey.connection_downlink} Mbps` : 'N/A');
                
                // DATOS PERSONALES
                addSection('DATOS PERSONALES');
                addField('Fecha de Nacimiento', currentSurvey.date_of_birth);
                addField('CURP', currentSurvey.curp);
                addField('NSS/IMSS', currentSurvey.nss_imss);
                addField('RFC', currentSurvey.rfc_tax_id);
                addField('Direcci√≥n', currentSurvey.full_address);
                
                // VIVIENDA
                addSection('VIVIENDA');
                addField('Tipo de Vivienda', currentSurvey.housing_type);
                addField('Vive Con', currentSurvey.lives_with);
                addField('Dependientes', currentSurvey.dependents_count?.toString());
                addField('Servicios', `Agua: ${currentSurvey.has_water ? 'S√≠' : 'No'} | Electricidad: ${currentSurvey.has_electricity ? 'S√≠' : 'No'} | Internet: ${currentSurvey.has_internet ? 'S√≠' : 'No'} | Gas: ${currentSurvey.has_gas ? 'S√≠' : 'No'}`);
                
                // EDUCACI√ìN Y EMPLEO
                addSection('EDUCACI√ìN Y EMPLEO');
                addField('Nivel de Estudios', currentSurvey.education_level);
                addField('Puesto Solicitado', currentSurvey.position_applying);
                addField('Organizaci√≥n', currentSurvey.organization);
                addField('√Årea/Divisi√≥n', currentSurvey.area_division);
                addField('Empleo Actual', currentSurvey.current_employment);
                addField('Empleo Anterior', currentSurvey.previous_employment);
                
                // INGRESOS
                addSection('INGRESOS');
                addField('Sueldo/Bonos', currentSurvey.salary_bonus);
                addField('Apoyo Familiar', currentSurvey.family_support);
                addField('Negocio Informal', currentSurvey.informal_business_income);
                
                // GASTOS
                addSection('GASTOS MENSUALES');
                addField('Despensa', currentSurvey.groceries);
                addField('Renta', currentSurvey.rent);
                addField('Servicios', currentSurvey.utilities);
                addField('Transporte', currentSurvey.transportation);
                addField('Educaci√≥n', currentSurvey.school_expenses);
                addField('Entretenimiento', currentSurvey.entertainment);
                
                // BIENES Y DEUDAS
                addSection('BIENES Y PATRIMONIO');
                addField('Bienes Ra√≠ces', currentSurvey.real_estate);
                addField('Veh√≠culos', currentSurvey.vehicles);
                addField('Negocios', currentSurvey.businesses);
                addField('Ahorros', currentSurvey.formal_savings);
                addField('Deudas', currentSurvey.debts);
                addField('Bur√≥ de Cr√©dito', currentSurvey.credit_bureau);
                
                // REFERENCIAS
                addSection('REFERENCIAS');
                addField('Referencias Familiares', currentSurvey.primary_family_contacts);
                addField('Referencias Laborales', currentSurvey.work_references);
                addField('Contacto de Emergencia', currentSurvey.emergency_contact_name);
                
                // ADD IMAGES SECTION
                if (surveyImages.length > 0) {
                    addSection(`üì∏ ARCHIVOS ADJUNTOS (${surveyImages.length})`);
                    
                    for (let i = 0; i < surveyImages.length; i++) {
                        const img = surveyImages[i];
                        const fileUrl = `${API_URL}/survey/file/${sessionId}/${img.id}`;
                        
                        try {
                            // Check if we need new page
                            if (yPos > pageHeight - 80) {
                                doc.addPage();
                                yPos = 20;
                            }
                            
                            // Add image title
                            doc.setFont(undefined, 'bold');
                            doc.setFontSize(9);
                            doc.text(`${i + 1}. ${img.file_name}`, margin, yPos);
                            yPos += 5;
                            
                            // Add image
                            doc.addImage(fileUrl, 'JPEG', margin, yPos, 80, 60);
                            yPos += 65;
                            
                        } catch (e) {
                            console.log('Could not add image:', img.file_name);
                            doc.setFont(undefined, 'normal');
                            doc.setFontSize(9);
                            doc.text(`[Imagen no disponible: ${img.file_name}]`, margin, yPos);
                            yPos += 7;
                        }
                    }
                }
                
                // Footer on all pages
                doc.setFontSize(8);
                doc.setTextColor(128, 128, 128);
                const pageCount = doc.internal.getNumberOfPages();
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.text(`P√°gina ${i} de ${pageCount}`, 105, 290, { align: 'center' });
                    doc.text('Generado por 6Cias - ' + new Date().toLocaleDateString('es-MX'), margin, 290);
                }
                
                // Save
                doc.save(`Encuesta_${currentSurvey.candidate_name || currentSurvey.session_id}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                // Reset button
                if (btn) {
                    btn.innerHTML = '‚úÖ PDF Generado!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
                
                } catch (error) {
                    console.error('Error generating PDF:', error);
                    alert('Error al generar PDF: ' + error.message);
                    if (btn) {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }
                }
            }

        // ==========================================
        // WORD EXPORT FUNCTION
        // ==========================================
        async function exportToWord() { 
            if (!currentSurvey) {
                alert('Por favor espera a que se carguen los datos');
                return;
            }
            
            // Get button reference
            const btn = document.querySelector('button[onclick="exportToWord()"]');
            
            // Check if docx library loaded
            if (typeof docx === 'undefined') {
                console.error('docx library not loaded - checking window.docx');
                
                // Try alternate path
                if (typeof window.docx === 'undefined') {
                    alert('Error: La librer√≠a de Word no est√° disponible.\n\nPor favor:\n1. Desactiva el "Tracking Prevention" en tu navegador\n2. Recarga la p√°gina\n3. Intenta de nuevo');
                    return;
                }
            }
            
            // Show loading
            const originalText = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '‚è≥ Generando Word...';
            }
            
            try {
                const { Document, Packer, Paragraph, TextRun, HeadingLevel, AlignmentType, ImageRun } = docx;
                
                // Get all images from survey
                let surveyImages = [];
                try {
                    const response = await fetch(`${API_URL}/survey/${sessionId}/files`);
                    const data = await response.json();
                    if (data.files && data.files.length > 0) {
                        surveyImages = data.files.filter(f => f.file_type && f.file_type.startsWith('image/'));
                    }
                } catch (e) {
                    console.log('No images to include');
                }

                const createHeading = (text) => {
                    return new Paragraph({
                        children: [
                            new TextRun({
                                text: text,
                                bold: true,
                                size: 28,
                                color: "FFFFFF"  // Force black text
                            })
                        ],
                        heading: HeadingLevel.HEADING_1,
                        spacing: { before: 400, after: 200 },
                        shading: {
                            fill: "008386"  // Keep green background
                        }
                    });
                };
                
                const createField = (label, value) => {
                    return new Paragraph({
                        children: [
                            new TextRun({
                                text: label + ": ",
                                bold: true,
                                size: 22
                            }),
                            new TextRun({
                                text: value || 'No proporcionado',
                                size: 22
                            })
                        ],
                        spacing: { after: 100 }
                    });
                };
                
                const sections = [];
                
                // HEADER
                sections.push(
                    new Paragraph({
                        text: "ENCUESTA SOCIOECON√ìMICA - 6CIAS",
                        heading: HeadingLevel.TITLE,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    }),
                    new Paragraph({
                        text: "Reporte Completo de Datos",
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 200 }
                    }),
                    new Paragraph({
                        text: `Generado: ${new Date().toLocaleString('es-MX')}`,
                        alignment: AlignmentType.CENTER,
                        spacing: { after: 600 }
                    })
                );
                
                // INFORMACI√ìN GENERAL
                sections.push(
                    createHeading("INFORMACI√ìN GENERAL"),
                    createField("Session ID", currentSurvey.session_id),
                    createField("Nombre", currentSurvey.candidate_name),
                    createField("Email", currentSurvey.email),
                    createField("Tel√©fono", currentSurvey.phone_whatsapp),
                    createField("Fecha de Creaci√≥n", currentSurvey.created_at ? new Date(currentSurvey.created_at).toLocaleDateString('es-MX') : 'N/A'),
                    createField("√öltima Actualizaci√≥n", currentSurvey.updated_at ? new Date(currentSurvey.updated_at).toLocaleDateString('es-MX') : 'N/A'),
                    createField("Estado", currentSurvey.survey_completed ? 'Completa ‚úì' : 'Incompleta ‚äò')
                );
                
                // UBICACI√ìN E IP
                sections.push(
                    createHeading("UBICACI√ìN E IP"),
                    createField("IP Address", currentSurvey.user_ip),
                    createField("Ciudad", currentSurvey.ip_city),
                    createField("Regi√≥n", currentSurvey.ip_region),
                    createField("Pa√≠s", currentSurvey.ip_country),
                    createField("C√≥digo Postal", currentSurvey.ip_postal_code),
                    createField("Coordenadas", currentSurvey.ip_latitude && currentSurvey.ip_longitude ? 
                        `${currentSurvey.ip_latitude}, ${currentSurvey.ip_longitude}` : 'N/A'),
                    createField("ISP", currentSurvey.ip_isp),
                    createField("Organizaci√≥n", currentSurvey.ip_organization),
                    createField("Timezone", currentSurvey.ip_timezone),
                    createField("Es Proxy/VPN", currentSurvey.ip_is_proxy ? 'S√≠ ‚ö†Ô∏è' : 'No'),
                    createField("Conexi√≥n M√≥vil", currentSurvey.ip_is_mobile ? 'S√≠' : 'No')
                );
                
                // NAVEGADOR Y DISPOSITIVO
                sections.push(
                    createHeading("NAVEGADOR Y DISPOSITIVO"),
                    createField("Navegador", `${currentSurvey.browser_name || 'N/A'} ${currentSurvey.browser_version || ''}`),
                    createField("Sistema Operativo", currentSurvey.browser_os),
                    createField("Plataforma", currentSurvey.browser_platform),
                    createField("Idioma", currentSurvey.browser_language),
                    createField("Timezone Navegador", currentSurvey.browser_timezone),
                    createField("Resoluci√≥n de Pantalla", currentSurvey.screen_width ? `${currentSurvey.screen_width}x${currentSurvey.screen_height}` : 'N/A'),
                    createField("Profundidad de Color", currentSurvey.screen_color_depth ? `${currentSurvey.screen_color_depth} bits` : 'N/A'),
                    createField("Device Pixel Ratio", currentSurvey.device_pixel_ratio),
                    createField("CPU Cores", currentSurvey.cpu_cores?.toString()),
                    createField("RAM", currentSurvey.device_memory ? `${currentSurvey.device_memory} GB` : 'N/A'),
                    createField("Soporte Touch", currentSurvey.has_touch_support ? 'S√≠' : 'No'),
                    createField("WebGL Vendor", currentSurvey.webgl_vendor),
                    createField("WebGL Renderer", currentSurvey.webgl_renderer),
                    createField("Canvas Fingerprint", currentSurvey.canvas_fingerprint),
                    createField("Tipo de Conexi√≥n", currentSurvey.connection_type),
                    createField("Conexi√≥n Efectiva", currentSurvey.connection_effective_type?.toUpperCase()),
                    createField("Velocidad de Descarga", currentSurvey.connection_downlink ? `${currentSurvey.connection_downlink} Mbps` : 'N/A'),
                    createField("Latencia (RTT)", currentSurvey.connection_rtt ? `${currentSurvey.connection_rtt} ms` : 'N/A')
                );
                
                // Continue with all other sections (same as before)...
                // DATOS PERSONALES
                sections.push(
                    createHeading("DATOS PERSONALES"),
                    createField("Fecha de Nacimiento", currentSurvey.date_of_birth),
                    createField("CURP", currentSurvey.curp),
                    createField("NSS/IMSS", currentSurvey.nss_imss),
                    createField("RFC", currentSurvey.rfc_tax_id),
                    createField("Direcci√≥n Completa", currentSurvey.full_address),
                    createField("Proveedor de Servicios", currentSurvey.utility_provider),
                    createField("N√∫mero de Contrato", currentSurvey.utility_contract_number)
                );
                
                // VIVIENDA
                sections.push(
                    createHeading("VIVIENDA"),
                    createField("Tipo de Vivienda", currentSurvey.housing_type),
                    createField("Vive Con", currentSurvey.lives_with),
                    createField("N√∫mero de Dependientes", currentSurvey.dependents_count?.toString()),
                    createField("Tiene Agua", currentSurvey.has_water ? 'S√≠' : 'No'),
                    createField("Tiene Electricidad", currentSurvey.has_electricity ? 'S√≠' : 'No'),
                    createField("Tiene Internet", currentSurvey.has_internet ? 'S√≠' : 'No'),
                    createField("Tiene Gas", currentSurvey.has_gas ? 'S√≠' : 'No'),
                    createField("Rec√°maras", currentSurvey.bedrooms),
                    createField("Ba√±os", currentSurvey.bathrooms),
                    createField("Pisos", currentSurvey.floors)
                );
                
                // EDUCACI√ìN Y EMPLEO
                sections.push(
                    createHeading("EDUCACI√ìN Y EMPLEO"),
                    createField("Nivel de Estudios", currentSurvey.education_level),
                    createField("Tiene Comprobante", currentSurvey.has_education_proof ? 'S√≠' : 'No'),
                    createField("Puesto Solicitado", currentSurvey.position_applying),
                    createField("Organizaci√≥n", currentSurvey.organization),
                    createField("√Årea/Divisi√≥n", currentSurvey.area_division),
                    createField("Empleo Actual", currentSurvey.current_employment),
                    createField("Empleo Anterior", currentSurvey.previous_employment)
                );
                
                // INGRESOS
                sections.push(
                    createHeading("INGRESOS"),
                    createField("Sueldo/Bonos", currentSurvey.salary_bonus),
                    createField("Apoyo Familiar", currentSurvey.family_support),
                    createField("Ingreso de Negocio Informal", currentSurvey.informal_business_income)
                );
                
                // GASTOS
                sections.push(
                    createHeading("GASTOS MENSUALES"),
                    createField("Despensa", currentSurvey.groceries),
                    createField("Renta", currentSurvey.rent),
                    createField("Servicios", currentSurvey.utilities),
                    createField("Transporte", currentSurvey.transportation),
                    createField("Gastos Escolares", currentSurvey.school_expenses),
                    createField("Entretenimiento", currentSurvey.entertainment)
                );
                
                // BIENES Y DEUDAS
                sections.push(
                    createHeading("BIENES Y PATRIMONIO"),
                    createField("Bienes Ra√≠ces", currentSurvey.real_estate),
                    createField("Veh√≠culos", currentSurvey.vehicles),
                    createField("Negocios", currentSurvey.businesses),
                    createField("Ahorros Formales", currentSurvey.formal_savings),
                    createHeading("DEUDAS"),
                    createField("Deudas Activas", currentSurvey.debts),
                    createField("Estado en Bur√≥ de Cr√©dito", currentSurvey.credit_bureau)
                );
                
                // REFERENCIAS
                sections.push(
                    createHeading("REFERENCIAS"),
                    createField("Referencias Familiares", currentSurvey.primary_family_contacts),
                    createField("Referencias Laborales", currentSurvey.work_references),
                    createField("Contacto de Emergencia", `${currentSurvey.emergency_contact_name || 'N/A'} - ${currentSurvey.emergency_contact_phone || 'N/A'}`)
                );
                
                // ADD IMAGES TO WORD
                if (surveyImages.length > 0) {
                    sections.push(createHeading(`üì∏ ARCHIVOS ADJUNTOS (${surveyImages.length})`));
                    
                    for (const img of surveyImages) {
                        const fileUrl = `${API_URL}/survey/file/${sessionId}/${img.id}`;
                        
                        try {
                            // Fetch image as blob
                            const imgResponse = await fetch(fileUrl);
                            const imgBlob = await imgResponse.blob();
                            const imgBuffer = await imgBlob.arrayBuffer();
                            
                            sections.push(
                                new Paragraph({
                                    text: img.file_name,
                                    bold: true,
                                    spacing: { before: 200, after: 100 }
                                }),
                                new Paragraph({
                                    children: [
                                        new ImageRun({
                                            data: imgBuffer,
                                            transformation: {
                                                width: 400,
                                                height: 300
                                            }
                                        })
                                    ],
                                    spacing: { after: 200 }
                                })
                            );
                        } catch (e) {
                            console.log('Could not add image to Word:', img.file_name);
                            sections.push(
                                new Paragraph({
                                    text: `[Imagen no disponible: ${img.file_name}]`,
                                    italics: true,
                                    spacing: { after: 100 }
                                })
                            );
                        }
                    }
                }
                
                // Create document
                const doc = new Document({
                    sections: [{
                        properties: {},
                        children: sections
                    }]
                });
                
                // Generate and save
                const blob = await Packer.toBlob(doc);
                saveAs(blob, `Encuesta_${currentSurvey.candidate_name || currentSurvey.session_id}_${new Date().toISOString().split('T')[0]}.docx`);
                
                // Reset button
                if (btn) {
                    btn.innerHTML = '‚úÖ Word Generado!';
                    setTimeout(() => {
                        btn.innerHTML = originalText;
                        btn.disabled = false;
                    }, 2000);
                }
                
            } catch (error) {
                console.error('Error generating Word document:', error);
                alert('Error al generar documento Word: ' + error.message);
                if (btn) {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }
            }
        }


    </script>
</body>

</html>